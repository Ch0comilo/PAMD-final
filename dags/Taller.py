{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "0bd3ec80",
   "metadata": {},
   "outputs": [],
   "source": [
    "from pyspark.sql import SparkSession\n",
    "from pyspark.sql.functions import from_json, col, broadcast, current_timestamp, regexp_replace\n",
    "from pyspark.sql.types import StructType, StructField, StringType, DoubleType, LongType, TimestampType\n",
    "import sparknlp"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e935c46f",
   "metadata": {},
   "source": [
    "# InicializaciÃ³n de SPARK"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "baf2b2e0",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      ":: loading settings :: url = jar:file:/opt/spark/jars/ivy-2.5.1.jar!/org/apache/ivy/core/settings/ivysettings.xml\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Ivy Default Cache set to: /root/.ivy2/cache\n",
      "The jars for the packages stored in: /root/.ivy2/jars\n",
      "io.delta#delta-spark_2.12 added as a dependency\n",
      "org.apache.spark#spark-sql-kafka-0-10_2.12 added as a dependency\n",
      "com.johnsnowlabs.nlp#spark-nlp_2.12 added as a dependency\n",
      ":: resolving dependencies :: org.apache.spark#spark-submit-parent-89187d20-4b06-479c-8250-647737ca6749;1.0\n",
      "\tconfs: [default]\n",
      "\tfound io.delta#delta-spark_2.12;3.1.0 in central\n",
      "\tfound io.delta#delta-storage;3.1.0 in central\n",
      "\tfound org.antlr#antlr4-runtime;4.9.3 in central\n",
      "\tfound org.apache.spark#spark-sql-kafka-0-10_2.12;3.5.1 in central\n",
      "\tfound org.apache.spark#spark-token-provider-kafka-0-10_2.12;3.5.1 in central\n",
      "\tfound org.apache.kafka#kafka-clients;3.4.1 in central\n",
      "\tfound org.lz4#lz4-java;1.8.0 in central\n",
      "\tfound org.xerial.snappy#snappy-java;1.1.10.3 in central\n",
      "\tfound org.slf4j#slf4j-api;2.0.7 in central\n",
      "\tfound org.apache.hadoop#hadoop-client-runtime;3.3.4 in central\n",
      "\tfound org.apache.hadoop#hadoop-client-api;3.3.4 in central\n",
      "\tfound commons-logging#commons-logging;1.1.3 in central\n",
      "\tfound com.google.code.findbugs#jsr305;3.0.0 in central\n",
      "\tfound org.apache.commons#commons-pool2;2.11.1 in central\n",
      "\tfound com.johnsnowlabs.nlp#spark-nlp_2.12;5.3.3 in central\n",
      "\tfound com.typesafe#config;1.4.2 in central\n",
      "\tfound org.rocksdb#rocksdbjni;6.29.5 in central\n",
      "\tfound com.amazonaws#aws-java-sdk-s3;1.12.500 in central\n",
      "\tfound com.amazonaws#aws-java-sdk-kms;1.12.500 in central\n",
      "\tfound com.amazonaws#aws-java-sdk-core;1.12.500 in central\n",
      "\tfound commons-codec#commons-codec;1.15 in central\n",
      "\tfound org.apache.httpcomponents#httpclient;4.5.13 in central\n",
      "\tfound org.apache.httpcomponents#httpcore;4.4.13 in central\n",
      "\tfound software.amazon.ion#ion-java;1.0.2 in central\n",
      "\tfound joda-time#joda-time;2.8.1 in central\n",
      "\tfound com.amazonaws#jmespath-java;1.12.500 in central\n",
      "\tfound com.github.universal-automata#liblevenshtein;3.0.0 in central\n",
      "\tfound com.google.protobuf#protobuf-java-util;3.0.0-beta-3 in central\n",
      "\tfound com.google.protobuf#protobuf-java;3.0.0-beta-3 in central\n",
      "\tfound com.google.code.gson#gson;2.3 in central\n",
      "\tfound it.unimi.dsi#fastutil;7.0.12 in central\n",
      "\tfound org.projectlombok#lombok;1.16.8 in central\n",
      "\tfound com.google.cloud#google-cloud-storage;2.20.1 in central\n",
      "\tfound com.google.guava#guava;31.1-jre in central\n",
      "\tfound com.google.guava#failureaccess;1.0.1 in central\n",
      "\tfound com.google.guava#listenablefuture;9999.0-empty-to-avoid-conflict-with-guava in central\n",
      "\tfound com.google.errorprone#error_prone_annotations;2.18.0 in central\n",
      "\tfound com.google.j2objc#j2objc-annotations;1.3 in central\n",
      "\tfound com.google.http-client#google-http-client;1.43.0 in central\n",
      "\tfound io.opencensus#opencensus-contrib-http-util;0.31.1 in central\n",
      "\tfound com.google.http-client#google-http-client-jackson2;1.43.0 in central\n",
      "\tfound com.google.http-client#google-http-client-gson;1.43.0 in central\n",
      "\tfound com.google.api-client#google-api-client;2.2.0 in central\n",
      "\tfound com.google.oauth-client#google-oauth-client;1.34.1 in central\n",
      "\tfound com.google.http-client#google-http-client-apache-v2;1.43.0 in central\n",
      "\tfound com.google.apis#google-api-services-storage;v1-rev20220705-2.0.0 in central\n",
      "\tfound com.google.code.gson#gson;2.10.1 in central\n",
      "\tfound com.google.cloud#google-cloud-core;2.12.0 in central\n",
      "\tfound io.grpc#grpc-context;1.53.0 in central\n",
      "\tfound com.google.auto.value#auto-value-annotations;1.10.1 in central\n",
      "\tfound com.google.auto.value#auto-value;1.10.1 in central\n",
      "\tfound javax.annotation#javax.annotation-api;1.3.2 in central\n",
      "\tfound com.google.cloud#google-cloud-core-http;2.12.0 in central\n",
      "\tfound com.google.http-client#google-http-client-appengine;1.43.0 in central\n",
      "\tfound com.google.api#gax-httpjson;0.108.2 in central\n",
      "\tfound com.google.cloud#google-cloud-core-grpc;2.12.0 in central\n",
      "\tfound io.grpc#grpc-alts;1.53.0 in central\n",
      "\tfound io.grpc#grpc-grpclb;1.53.0 in central\n",
      "\tfound org.conscrypt#conscrypt-openjdk-uber;2.5.2 in central\n",
      "\tfound io.grpc#grpc-auth;1.53.0 in central\n",
      "\tfound io.grpc#grpc-protobuf;1.53.0 in central\n",
      "\tfound io.grpc#grpc-protobuf-lite;1.53.0 in central\n",
      "\tfound io.grpc#grpc-core;1.53.0 in central\n",
      "\tfound com.google.api#gax;2.23.2 in central\n",
      "\tfound com.google.api#gax-grpc;2.23.2 in central\n",
      "\tfound com.google.auth#google-auth-library-credentials;1.16.0 in central\n",
      "\tfound com.google.auth#google-auth-library-oauth2-http;1.16.0 in central\n",
      "\tfound com.google.api#api-common;2.6.2 in central\n",
      "\tfound io.opencensus#opencensus-api;0.31.1 in central\n",
      "\tfound com.google.api.grpc#proto-google-iam-v1;1.9.2 in central\n",
      "\tfound com.google.protobuf#protobuf-java;3.21.12 in central\n",
      "\tfound com.google.protobuf#protobuf-java-util;3.21.12 in central\n",
      "\tfound com.google.api.grpc#proto-google-common-protos;2.14.2 in central\n",
      "\tfound org.threeten#threetenbp;1.6.5 in central\n",
      "\tfound com.google.api.grpc#proto-google-cloud-storage-v2;2.20.1-alpha in central\n",
      "\tfound com.google.api.grpc#grpc-google-cloud-storage-v2;2.20.1-alpha in central\n",
      "\tfound com.google.api.grpc#gapic-google-cloud-storage-v2;2.20.1-alpha in central\n",
      "\tfound com.google.code.findbugs#jsr305;3.0.2 in central\n",
      "\tfound io.grpc#grpc-api;1.53.0 in central\n",
      "\tfound io.grpc#grpc-stub;1.53.0 in central\n",
      "\tfound org.checkerframework#checker-qual;3.31.0 in central\n",
      "\tfound io.perfmark#perfmark-api;0.26.0 in central\n",
      "\tfound com.google.android#annotations;4.1.1.4 in central\n",
      "\tfound org.codehaus.mojo#animal-sniffer-annotations;1.22 in central\n",
      "\tfound io.opencensus#opencensus-proto;0.2.0 in central\n",
      "\tfound io.grpc#grpc-services;1.53.0 in central\n",
      "\tfound com.google.re2j#re2j;1.6 in central\n",
      "\tfound io.grpc#grpc-netty-shaded;1.53.0 in central\n",
      "\tfound io.grpc#grpc-googleapis;1.53.0 in central\n",
      "\tfound io.grpc#grpc-xds;1.53.0 in central\n",
      "\tfound com.navigamez#greex;1.0 in central\n",
      "\tfound dk.brics.automaton#automaton;1.11-8 in central\n",
      "\tfound com.johnsnowlabs.nlp#tensorflow-cpu_2.12;0.4.4 in central\n",
      "\tfound com.microsoft.onnxruntime#onnxruntime;1.17.0 in central\n",
      ":: resolution report :: resolve 1216ms :: artifacts dl 58ms\n",
      "\t:: modules in use:\n",
      "\tcom.amazonaws#aws-java-sdk-core;1.12.500 from central in [default]\n",
      "\tcom.amazonaws#aws-java-sdk-kms;1.12.500 from central in [default]\n",
      "\tcom.amazonaws#aws-java-sdk-s3;1.12.500 from central in [default]\n",
      "\tcom.amazonaws#jmespath-java;1.12.500 from central in [default]\n",
      "\tcom.github.universal-automata#liblevenshtein;3.0.0 from central in [default]\n",
      "\tcom.google.android#annotations;4.1.1.4 from central in [default]\n",
      "\tcom.google.api#api-common;2.6.2 from central in [default]\n",
      "\tcom.google.api#gax;2.23.2 from central in [default]\n",
      "\tcom.google.api#gax-grpc;2.23.2 from central in [default]\n",
      "\tcom.google.api#gax-httpjson;0.108.2 from central in [default]\n",
      "\tcom.google.api-client#google-api-client;2.2.0 from central in [default]\n",
      "\tcom.google.api.grpc#gapic-google-cloud-storage-v2;2.20.1-alpha from central in [default]\n",
      "\tcom.google.api.grpc#grpc-google-cloud-storage-v2;2.20.1-alpha from central in [default]\n",
      "\tcom.google.api.grpc#proto-google-cloud-storage-v2;2.20.1-alpha from central in [default]\n",
      "\tcom.google.api.grpc#proto-google-common-protos;2.14.2 from central in [default]\n",
      "\tcom.google.api.grpc#proto-google-iam-v1;1.9.2 from central in [default]\n",
      "\tcom.google.apis#google-api-services-storage;v1-rev20220705-2.0.0 from central in [default]\n",
      "\tcom.google.auth#google-auth-library-credentials;1.16.0 from central in [default]\n",
      "\tcom.google.auth#google-auth-library-oauth2-http;1.16.0 from central in [default]\n",
      "\tcom.google.auto.value#auto-value;1.10.1 from central in [default]\n",
      "\tcom.google.auto.value#auto-value-annotations;1.10.1 from central in [default]\n",
      "\tcom.google.cloud#google-cloud-core;2.12.0 from central in [default]\n",
      "\tcom.google.cloud#google-cloud-core-grpc;2.12.0 from central in [default]\n",
      "\tcom.google.cloud#google-cloud-core-http;2.12.0 from central in [default]\n",
      "\tcom.google.cloud#google-cloud-storage;2.20.1 from central in [default]\n",
      "\tcom.google.code.findbugs#jsr305;3.0.2 from central in [default]\n",
      "\tcom.google.code.gson#gson;2.10.1 from central in [default]\n",
      "\tcom.google.errorprone#error_prone_annotations;2.18.0 from central in [default]\n",
      "\tcom.google.guava#failureaccess;1.0.1 from central in [default]\n",
      "\tcom.google.guava#guava;31.1-jre from central in [default]\n",
      "\tcom.google.guava#listenablefuture;9999.0-empty-to-avoid-conflict-with-guava from central in [default]\n",
      "\tcom.google.http-client#google-http-client;1.43.0 from central in [default]\n",
      "\tcom.google.http-client#google-http-client-apache-v2;1.43.0 from central in [default]\n",
      "\tcom.google.http-client#google-http-client-appengine;1.43.0 from central in [default]\n",
      "\tcom.google.http-client#google-http-client-gson;1.43.0 from central in [default]\n",
      "\tcom.google.http-client#google-http-client-jackson2;1.43.0 from central in [default]\n",
      "\tcom.google.j2objc#j2objc-annotations;1.3 from central in [default]\n",
      "\tcom.google.oauth-client#google-oauth-client;1.34.1 from central in [default]\n",
      "\tcom.google.protobuf#protobuf-java;3.21.12 from central in [default]\n",
      "\tcom.google.protobuf#protobuf-java-util;3.21.12 from central in [default]\n",
      "\tcom.google.re2j#re2j;1.6 from central in [default]\n",
      "\tcom.johnsnowlabs.nlp#spark-nlp_2.12;5.3.3 from central in [default]\n",
      "\tcom.johnsnowlabs.nlp#tensorflow-cpu_2.12;0.4.4 from central in [default]\n",
      "\tcom.microsoft.onnxruntime#onnxruntime;1.17.0 from central in [default]\n",
      "\tcom.navigamez#greex;1.0 from central in [default]\n",
      "\tcom.typesafe#config;1.4.2 from central in [default]\n",
      "\tcommons-codec#commons-codec;1.15 from central in [default]\n",
      "\tcommons-logging#commons-logging;1.1.3 from central in [default]\n",
      "\tdk.brics.automaton#automaton;1.11-8 from central in [default]\n",
      "\tio.delta#delta-spark_2.12;3.1.0 from central in [default]\n",
      "\tio.delta#delta-storage;3.1.0 from central in [default]\n",
      "\tio.grpc#grpc-alts;1.53.0 from central in [default]\n",
      "\tio.grpc#grpc-api;1.53.0 from central in [default]\n",
      "\tio.grpc#grpc-auth;1.53.0 from central in [default]\n",
      "\tio.grpc#grpc-context;1.53.0 from central in [default]\n",
      "\tio.grpc#grpc-core;1.53.0 from central in [default]\n",
      "\tio.grpc#grpc-googleapis;1.53.0 from central in [default]\n",
      "\tio.grpc#grpc-grpclb;1.53.0 from central in [default]\n",
      "\tio.grpc#grpc-netty-shaded;1.53.0 from central in [default]\n",
      "\tio.grpc#grpc-protobuf;1.53.0 from central in [default]\n",
      "\tio.grpc#grpc-protobuf-lite;1.53.0 from central in [default]\n",
      "\tio.grpc#grpc-services;1.53.0 from central in [default]\n",
      "\tio.grpc#grpc-stub;1.53.0 from central in [default]\n",
      "\tio.grpc#grpc-xds;1.53.0 from central in [default]\n",
      "\tio.opencensus#opencensus-api;0.31.1 from central in [default]\n",
      "\tio.opencensus#opencensus-contrib-http-util;0.31.1 from central in [default]\n",
      "\tio.opencensus#opencensus-proto;0.2.0 from central in [default]\n",
      "\tio.perfmark#perfmark-api;0.26.0 from central in [default]\n",
      "\tit.unimi.dsi#fastutil;7.0.12 from central in [default]\n",
      "\tjavax.annotation#javax.annotation-api;1.3.2 from central in [default]\n",
      "\tjoda-time#joda-time;2.8.1 from central in [default]\n",
      "\torg.antlr#antlr4-runtime;4.9.3 from central in [default]\n",
      "\torg.apache.commons#commons-pool2;2.11.1 from central in [default]\n",
      "\torg.apache.hadoop#hadoop-client-api;3.3.4 from central in [default]\n",
      "\torg.apache.hadoop#hadoop-client-runtime;3.3.4 from central in [default]\n",
      "\torg.apache.httpcomponents#httpclient;4.5.13 from central in [default]\n",
      "\torg.apache.httpcomponents#httpcore;4.4.13 from central in [default]\n",
      "\torg.apache.kafka#kafka-clients;3.4.1 from central in [default]\n",
      "\torg.apache.spark#spark-sql-kafka-0-10_2.12;3.5.1 from central in [default]\n",
      "\torg.apache.spark#spark-token-provider-kafka-0-10_2.12;3.5.1 from central in [default]\n",
      "\torg.checkerframework#checker-qual;3.31.0 from central in [default]\n",
      "\torg.codehaus.mojo#animal-sniffer-annotations;1.22 from central in [default]\n",
      "\torg.conscrypt#conscrypt-openjdk-uber;2.5.2 from central in [default]\n",
      "\torg.lz4#lz4-java;1.8.0 from central in [default]\n",
      "\torg.projectlombok#lombok;1.16.8 from central in [default]\n",
      "\torg.rocksdb#rocksdbjni;6.29.5 from central in [default]\n",
      "\torg.slf4j#slf4j-api;2.0.7 from central in [default]\n",
      "\torg.threeten#threetenbp;1.6.5 from central in [default]\n",
      "\torg.xerial.snappy#snappy-java;1.1.10.3 from central in [default]\n",
      "\tsoftware.amazon.ion#ion-java;1.0.2 from central in [default]\n",
      "\t:: evicted modules:\n",
      "\tcom.google.code.findbugs#jsr305;3.0.0 by [com.google.code.findbugs#jsr305;3.0.2] in [default]\n",
      "\tcommons-logging#commons-logging;1.2 by [commons-logging#commons-logging;1.1.3] in [default]\n",
      "\tcommons-codec#commons-codec;1.11 by [commons-codec#commons-codec;1.15] in [default]\n",
      "\tcom.google.protobuf#protobuf-java-util;3.0.0-beta-3 by [com.google.protobuf#protobuf-java-util;3.21.12] in [default]\n",
      "\tcom.google.protobuf#protobuf-java;3.0.0-beta-3 by [com.google.protobuf#protobuf-java;3.21.12] in [default]\n",
      "\tcom.google.code.gson#gson;2.3 by [com.google.code.gson#gson;2.10.1] in [default]\n",
      "\t---------------------------------------------------------------------\n",
      "\t|                  |            modules            ||   artifacts   |\n",
      "\t|       conf       | number| search|dwnlded|evicted|| number|dwnlded|\n",
      "\t---------------------------------------------------------------------\n",
      "\t|      default     |   96  |   0   |   0   |   6   ||   90  |   0   |\n",
      "\t---------------------------------------------------------------------\n",
      ":: retrieving :: org.apache.spark#spark-submit-parent-89187d20-4b06-479c-8250-647737ca6749\n",
      "\tconfs: [default]\n",
      "\t0 artifacts copied, 90 already retrieved (0kB/20ms)\n",
      "25/12/12 14:54:08 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable\n",
      "Setting default log level to \"WARN\".\n",
      "To adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ… SesiÃ³n de Spark iniciada y conectada al Master spark://0.0.0.0:7077 con Spark NLP v5.3.3.\n"
     ]
    }
   ],
   "source": [
    "# --- IMPORTS Y CONFIGURACIÃ“N ---\n",
    "from pyspark.sql import SparkSession\n",
    "from pyspark.sql.functions import col\n",
    "import sparknlp \n",
    "# Importa el resto de las funciones necesarias para tu pipeline de NLP\n",
    "\n",
    "# --- CONFIGURACIÃ“N DE PAQUETES ---\n",
    "SPARK_MASTER = \"spark://0.0.0.0:7077\" # DirecciÃ³n de tu Spark Master dentro de Docker\n",
    "SPARK_NLP_VERSION = \"5.3.3\" \n",
    "\n",
    "# Lista de paquetes para Spark (Kafka, Delta, y Spark NLP)\n",
    "SPARK_PACKAGES = (\n",
    "    \"io.delta:delta-spark_2.12:3.1.0,\"\n",
    "    \"org.apache.spark:spark-sql-kafka-0-10_2.12:3.5.1,\"\n",
    "    f\"com.johnsnowlabs.nlp:spark-nlp_2.12:{SPARK_NLP_VERSION}\" \n",
    ")\n",
    "\n",
    "# --- INICIALIZACIÃ“N DE SPARK CON PAQUETES ---\n",
    "\n",
    "\n",
    "# --- CREACIÃ“N DE LA SPARK SESSION ---\n",
    "spark = (SparkSession.builder \\\n",
    "    .appName(\"GoldLayer_BERT_Embeddings\") \\\n",
    "    .master(SPARK_MASTER) \\\n",
    "    .config(\"spark.jars.packages\", SPARK_PACKAGES) \\\n",
    "    .config(\"spark.sql.extensions\", \"io.delta.sql.DeltaSparkSessionExtension\") \\\n",
    "    .config(\"spark.sql.catalog.spark_catalog\", \"org.apache.spark.sql.delta.catalog.DeltaCatalog\") \\\n",
    "    \n",
    "\n",
    "    .config(\"spark.driver.memory\", \"8g\") \\\n",
    "    \n",
    "    .config(\"spark.executor.memory\", \"4g\") \\\n",
    "    \n",
    "    .getOrCreate())\n",
    "\n",
    "print(f\"âœ… SesiÃ³n de Spark iniciada y conectada al Master {SPARK_MASTER} con Spark NLP v{SPARK_NLP_VERSION}.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "f26b3dfe",
   "metadata": {},
   "source": [
    "# FASE 2"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0036ca6e",
   "metadata": {},
   "source": [
    "# Ingesta: Leer stream de Kafka"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "c4963943",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "25/12/12 14:54:26 WARN GarbageCollectionMetrics: To enable non-built-in garbage collector(s) List(G1 Concurrent GC), users should configure it(them) to spark.eventLog.gcMetrics.youngGenerationGarbageCollectors or spark.eventLog.gcMetrics.oldGenerationGarbageCollectors\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Stream de Kafka configurado.\n"
     ]
    }
   ],
   "source": [
    "# Esquema de los datos reales del productor (8 campos clave + 6 auxiliares)\n",
    "CONTRACT_SCHEMA = StructType([\n",
    "    # Campos clave para ML\n",
    "    StructField(\"id_contrato\", StringType(), True),\n",
    "    StructField(\"objeto_contrato\", StringType(), True),\n",
    "    StructField(\"entidad\", StringType(), True),\n",
    "    StructField(\"codigo_unspsc\", StringType(), True), \n",
    "    StructField(\"duracion_dias\", LongType(), True),\n",
    "    StructField(\"valor_contrato\", DoubleType(), True),\n",
    "    StructField(\"fecha_firma\", StringType(), True),\n",
    "    StructField(\"departamento\", StringType(), True),\n",
    "    \n",
    "    # Columnas ruidosas / auxiliares (SerÃ¡n eliminadas)\n",
    "    StructField(\"nit_entidad\", StringType(), True), \n",
    "    StructField(\"localizacion\", StringType(), True),\n",
    "    StructField(\"sector\", StringType(), True), \n",
    "    StructField(\"es_pyme\", StringType(), True),\n",
    "    StructField(\"valor_facturado\", StringType(), True), # Aunque es numÃ©rico, puede venir sucio\n",
    "    StructField(\"urlproceso\", StringType(), True),\n",
    "])\n",
    "\n",
    "# 1. Tarea: Leer el stream de Kafka\n",
    "kafka_stream = (spark.readStream\n",
    "    .format(\"kafka\") \n",
    "    .option(\"kafka.bootstrap.servers\", \"kafka:29092\")\n",
    "    .option(\"subscribe\", \"contratos-publicos\")\n",
    "    .option(\"startingOffsets\", \"earliest\") # Para procesar datos desde el inicio (si el productor ya corriÃ³)\n",
    "    .load()\n",
    ")\n",
    "\n",
    "print(\"Stream de Kafka configurado.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "35d0c978",
   "metadata": {},
   "source": [
    "# PreparaciÃ³n de los datos"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "7088408d",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "DataFrame de Regiones (Broadcast) listo para el Join.\n"
     ]
    }
   ],
   "source": [
    "# Definimos los departamentos que forman parte del Eje Cafetero para el filtro\n",
    "regiones_eje_cafetero = [\n",
    "    (\"Antioquia\", \"Eje Cafetero\"), (\"Caldas\", \"Eje Cafetero\"), \n",
    "    (\"Quindio\", \"Eje Cafetero\"), (\"Risaralda\", \"Eje Cafetero\"), \n",
    "    (\"Tolima\", \"Eje Cafetero\"), (\"Valle del Cauca\", \"Eje Cafetero\")\n",
    "]\n",
    "df_regiones = spark.createDataFrame(regiones_eje_cafetero).toDF(\"departamento_join\", \"macrorregion_turistica\")\n",
    "\n",
    "# Aplicamos Broadcasting para optimizar el JOIN (Broadcasting Join)\n",
    "df_regiones_broadcast = broadcast(df_regiones)\n",
    "print(\"DataFrame de Regiones (Broadcast) listo para el Join.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "69a26204",
   "metadata": {},
   "source": [
    "# Persistencia en Delta-Lake"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "3d011fa5",
   "metadata": {},
   "outputs": [],
   "source": [
    "df_silver = (kafka_stream \\\n",
    "    # 2. ExplosiÃ³n de Metadatos\n",
    "    .withColumn(\"value_content\", from_json(col(\"value\").cast(\"string\"), CONTRACT_SCHEMA)) \\\n",
    "    .select(\n",
    "        col(\"value_content.*\"),\n",
    "        col(\"timestamp\").alias(\"kafka_ingestion_time\"), # Metadato de Kafka\n",
    "        col(\"offset\").alias(\"kafka_offset\")             # Metadato de Kafka\n",
    "    ) \\\n",
    "    \n",
    "    # 3. Tarea: Limpieza (EliminaciÃ³n de Redundantes)\n",
    "    .drop(\"nit_entidad\", \"localizacion\", \"sector\", \"es_pyme\", \"valor_facturado\", \"urlproceso\") \\\n",
    "    \n",
    "    # 3. Tarea: Cruce con Regiones (Broadcasting Join)\n",
    "    .join(\n",
    "        df_regiones_broadcast,\n",
    "        on=df_regiones_broadcast.departamento_join == col(\"departamento\"),\n",
    "        how=\"inner\" # INNER JOIN garantiza que solo pasen los del Eje Cafetero\n",
    "    ) \\\n",
    "    .drop(\"departamento_join\") \\\n",
    "    \n",
    "    # Limpieza final de valores (solo si es necesario para asegurar tipos, aunque ya se hizo en el productor)\n",
    "    .withColumn(\"departamento\", col(\"departamento\").cast(StringType())) \\\n",
    "    .withColumn(\"processing_time\", current_timestamp())\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "a12440d6",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Rutas para el almacenamiento Delta Lake\n",
    "DELTA_LAKE_PATH = \"/opt/spark/data/delta/silver_contracts\"\n",
    "CHECKPOINT_PATH = \"/opt/spark/data/checkpoints/silver_contracts\""
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0f81e0b5",
   "metadata": {},
   "source": [
    "# Persistencia Delta-Lake"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "b407d311",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                "
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Escritura del Stream a Delta Lake iniciada. Estado del Query ID: b89dcbd6-c9ec-4512-9d9f-a40dcb5eef3c\n",
      "El Job estÃ¡ corriendo. Presiona el botÃ³n de 'Stop' o interrupciÃ³n del kernel en Jupyter para detenerlo.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "25/12/12 14:54:46 WARN ResolveWriteToStream: spark.sql.adaptive.enabled is not supported in streaming DataFrames/Datasets and will be disabled.\n",
      "25/12/12 14:54:46 WARN AdminClientConfig: These configurations '[key.deserializer, value.deserializer, enable.auto.commit, max.poll.records, auto.offset.reset]' were supplied but are not used yet.\n",
      "25/12/12 14:54:47 WARN SparkStringUtils: Truncated the string representation of a plan since it was too large. This behavior can be adjusted by setting 'spark.sql.debug.maxToStringFields'.\n",
      "25/12/12 14:55:02 WARN ProcessingTimeExecutor: Current batch is falling behind. The trigger interval is 10000 milliseconds, but spent 15837 milliseconds\n",
      "                                                                                "
     ]
    }
   ],
   "source": [
    "# Rutas para el almacenamiento Delta Lake\n",
    "\n",
    "# 4. Tarea: Guardar los datos limpios en formato Delta Lake\n",
    "query = (df_silver.writeStream \\\n",
    "    .format(\"delta\") \\\n",
    "    .outputMode(\"append\") # AÃ±adir nuevos registros\n",
    "    .option(\"checkpointLocation\", CHECKPOINT_PATH) # Obligatorio para Spark Streaming\n",
    "    .option(\"path\", DELTA_LAKE_PATH) \n",
    "    .trigger(processingTime='10 seconds') # Procesa nuevos datos cada 10 segundos\n",
    "    .start()\n",
    ")\n",
    "\n",
    "print(f\"Escritura del Stream a Delta Lake iniciada. Estado del Query ID: {query.id}\")\n",
    "print(\"El Job estÃ¡ corriendo. Presiona el botÃ³n de 'Stop' o interrupciÃ³n del kernel en Jupyter para detenerlo.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4d047b5b",
   "metadata": {},
   "source": [
    "# FASE 3"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "27aea0f5",
   "metadata": {},
   "source": [
    "## Embeddings BERT"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "b9717dde",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ… Eliminado /opt/spark/data/delta/gold_contracts\n",
      "âœ… Eliminado /opt/spark/data/checkpoints/gold_contracts\n",
      "ðŸ”„ Listo para reiniciar el proceso GOLD con el schema correcto.\n"
     ]
    }
   ],
   "source": [
    "# EJECUTA ESTO PRIMERO para limpiar la tabla anterior\n",
    "import shutil\n",
    "import os\n",
    "\n",
    "GOLD_DELTA_PATH = \"/opt/spark/data/delta/gold_contracts\"\n",
    "GOLD_CHECKPOINT_PATH = \"/opt/spark/data/checkpoints/gold_contracts\"\n",
    "\n",
    "# Detener el query anterior si estÃ¡ corriendo\n",
    "try:\n",
    "    spark.streams.get(\"df023a71-e21f-4108-ad66-dada639a0ce4\").stop()\n",
    "except:\n",
    "    pass\n",
    "\n",
    "# Eliminar los datos y checkpoints anteriores\n",
    "if os.path.exists(GOLD_DELTA_PATH):\n",
    "    shutil.rmtree(GOLD_DELTA_PATH)\n",
    "    print(f\"âœ… Eliminado {GOLD_DELTA_PATH}\")\n",
    "\n",
    "if os.path.exists(GOLD_CHECKPOINT_PATH):\n",
    "    shutil.rmtree(GOLD_CHECKPOINT_PATH)\n",
    "    print(f\"âœ… Eliminado {GOLD_CHECKPOINT_PATH}\")\n",
    "\n",
    "print(\"ðŸ”„ Listo para reiniciar el proceso GOLD con el schema correcto.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "3733f16b",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "sent_small_bert_L2_128 download started this may take some time.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                "
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Approximate size to download 16.1 MB\n",
      "[ | ]sent_small_bert_L2_128 download started this may take some time.\n",
      "Approximate size to download 16.1 MB\n",
      "Download done! Loading the resource.\n",
      "[ / ]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2025-12-12 14:55:33.402394: I external/org_tensorflow/tensorflow/core/platform/cpu_feature_guard.cc:151] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA\n",
      "To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "[OK!]\n",
      "âœ… Pipeline definido.\n",
      "â³ Cargando modelo BERT...\n",
      "âœ… Modelo BERT cargado.\n",
      "âœ… Proceso GOLD iniciado. Escribiendo en /opt/spark/data/delta/gold_contracts\n",
      "Query ID: cd3a202d-2bf5-496b-9c92-1ca0883f4527\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "25/12/12 14:55:35 WARN ResolveWriteToStream: spark.sql.adaptive.enabled is not supported in streaming DataFrames/Datasets and will be disabled.\n"
     ]
    }
   ],
   "source": [
    "from pyspark.sql import SparkSession\n",
    "from pyspark.sql.functions import col, udf\n",
    "from pyspark.sql.types import ArrayType, FloatType\n",
    "import sparknlp \n",
    "from sparknlp.base import DocumentAssembler\n",
    "from sparknlp.annotator import BertSentenceEmbeddings\n",
    "from pyspark.ml import Pipeline\n",
    "\n",
    "# --- PIPELINE SIMPLIFICADO (SIN FINISHER) ---\n",
    "\n",
    "document_assembler = DocumentAssembler() \\\n",
    "    .setInputCol(\"objeto_contrato\") \\\n",
    "    .setOutputCol(\"document\")\n",
    "\n",
    "bert_embeddings = BertSentenceEmbeddings.pretrained(\"sent_small_bert_L2_128\", \"en\") \\\n",
    "    .setInputCols([\"document\"]) \\\n",
    "    .setOutputCol(\"bert_vector\") \\\n",
    "    .setMaxSentenceLength(128)\n",
    "\n",
    "nlp_pipeline = Pipeline(stages=[\n",
    "    document_assembler,\n",
    "    bert_embeddings\n",
    "])\n",
    "\n",
    "print(\"âœ… Pipeline definido.\")\n",
    "\n",
    "# --- PRE-ENTRENAMIENTO ---\n",
    "print(\"â³ Cargando modelo BERT...\")\n",
    "SILVER_DELTA_PATH = \"/opt/spark/data/delta/silver_contracts\"\n",
    "df_sample = spark.read.format(\"delta\").load(SILVER_DELTA_PATH).limit(1)\n",
    "pipeline_model = nlp_pipeline.fit(df_sample)\n",
    "print(\"âœ… Modelo BERT cargado.\")\n",
    "\n",
    "# ==============================================================================\n",
    "# UDF para extraer embeddings\n",
    "# ==============================================================================\n",
    "\n",
    "def extract_embeddings(bert_vector_column):\n",
    "    if bert_vector_column and len(bert_vector_column) > 0:\n",
    "        first_annotation = bert_vector_column[0]\n",
    "        if first_annotation and hasattr(first_annotation, 'embeddings'):\n",
    "            return first_annotation.embeddings\n",
    "    return None\n",
    "\n",
    "extract_embeddings_udf = udf(extract_embeddings, ArrayType(FloatType()))\n",
    "\n",
    "# ==============================================================================\n",
    "# PROCESAMIENTO STREAMING\n",
    "# ==============================================================================\n",
    "\n",
    "GOLD_DELTA_PATH = \"/opt/spark/data/delta/gold_contracts\"\n",
    "GOLD_CHECKPOINT_PATH = \"/opt/spark/data/checkpoints/gold_contracts\"\n",
    "\n",
    "df_silver_stream = spark.readStream \\\n",
    "    .format(\"delta\") \\\n",
    "    .load(SILVER_DELTA_PATH)\n",
    "\n",
    "df_gold = pipeline_model.transform(df_silver_stream)\n",
    "\n",
    "df_gold_final = df_gold.select(\n",
    "    col(\"id_contrato\"),\n",
    "    col(\"entidad\"),\n",
    "    col(\"departamento\"),\n",
    "    col(\"valor_contrato\"),\n",
    "    col(\"duracion_dias\"),\n",
    "    col(\"codigo_unspsc\"),\n",
    "    extract_embeddings_udf(col(\"bert_vector\")).alias(\"objeto_embedding\"),\n",
    "    col(\"kafka_ingestion_time\"),\n",
    "    col(\"processing_time\")\n",
    ")\n",
    "\n",
    "query_gold = (df_gold_final.writeStream \\\n",
    "    .format(\"delta\") \\\n",
    "    .outputMode(\"append\") \n",
    "    .option(\"checkpointLocation\", GOLD_CHECKPOINT_PATH)\n",
    "    .option(\"path\", GOLD_DELTA_PATH) \n",
    "    .trigger(processingTime='30 seconds')\n",
    "    .start())\n",
    "\n",
    "print(f\"âœ… Proceso GOLD iniciado. Escribiendo en {GOLD_DELTA_PATH}\")\n",
    "print(f\"Query ID: {query_gold.id}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7b019f55",
   "metadata": {},
   "source": [
    "### VerificaciÃ³n GOLD"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "83464967",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== SCHEMA GOLD ===\n",
      "root\n",
      " |-- id_contrato: string (nullable = true)\n",
      " |-- entidad: string (nullable = true)\n",
      " |-- departamento: string (nullable = true)\n",
      " |-- valor_contrato: double (nullable = true)\n",
      " |-- duracion_dias: long (nullable = true)\n",
      " |-- codigo_unspsc: string (nullable = true)\n",
      " |-- objeto_embedding: array (nullable = true)\n",
      " |    |-- element: float (containsNull = true)\n",
      " |-- kafka_ingestion_time: timestamp (nullable = true)\n",
      " |-- processing_time: timestamp (nullable = true)\n",
      "\n",
      "\n",
      "=== SAMPLE ROWS (10) ===\n",
      "+------------------+----------------------------------------------------------------+---------------+--------------+-------------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------+-----------------------+\n",
      "|id_contrato       |entidad                                                         |departamento   |valor_contrato|duracion_dias|codigo_unspsc|objeto_embedding                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |kafka_ingestion_time   |processing_time        |\n",
      "+------------------+----------------------------------------------------------------+---------------+--------------+-------------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------+-----------------------+\n",
      "|CO1.PCCNTR.6277223|DISTRITO ESPECIAL DE CIENCIA TECNOLOGIA E INNOVACION DE MEDELLIN|Antioquia      |2.122311908E9 |0            |V1.86121500  |[-1.866925, 0.0075976807, -0.79524845, -2.9479933, -0.56865007, 0.56284213, -0.08927915, -0.8626236, -1.3537011, 0.254236, 0.9326776, -0.45368665, -2.0360966, 0.029971687, 0.63237894, -1.300345, -1.030171, 1.0722266, -2.007351, 0.8199897, 1.5832982, 0.15689406, 1.497932, 1.1177397, 2.06305, -0.74755156, 0.2565995, -0.05693402, 0.76637095, -0.2613934, -1.0536606, -0.87883437, 0.1296615, 0.9014519, -0.40080962, -1.2743711, -0.46013805, -0.42939487, -2.3930855, -1.8069068, 0.5739975, -0.08744939, 1.3287873, -0.67605996, -0.36636496, -1.0662296, 0.022735415, -0.93173456, 1.1957145, -0.047886785, -0.52056843, 2.2782795, 0.41879717, 0.35352528, 0.7905873, -0.694696, -0.037872095, -0.130888, -0.24055012, 2.5352306, 1.6809584, -0.4996769, 0.3686142, -0.9322733, -1.5323715, 1.0316118, 0.6954912, 1.0563064, 0.38490522, 0.6460886, -0.5605112, -0.46351996, 0.6074251, -1.3881794, -0.91807777, -0.096949644, 1.3092773, 0.42897305, 1.4425193, 0.72141004, 0.37091342, -0.04243785, 0.26511037, 0.5983671, 0.2644794, 0.33265483, -0.9748375, 0.014292852, 0.98954266, -0.5001216, 0.7122749, -0.21733524, -1.0297965, 1.3067622, 0.34184626, 1.4343764, 0.10675654, -0.6309908, 0.20488046, 0.030974373, -0.77566016, -0.46113804, -0.21613203, -0.66530156, 0.32858896, -2.0713456, -1.5743291, 1.0057228, 0.72191644, -0.5333771, -0.41350463, 1.7749388, 1.220602, -0.35612425, 0.05195254, 0.57648593, -0.7822317, -0.6235696, -0.452714, -0.8174999, -0.6126899, 0.25315872, 1.0054396, -1.2926638, -1.0885426, -1.0708004, -0.8814962, 0.3919137]           |2025-12-10 23:26:21.953|2025-12-10 23:26:30.005|\n",
      "|CO1.PCCNTR.3124784|CORPOURABA                                                      |Antioquia      |0.0           |0            |V1.80111701  |[-1.866925, 0.0075976807, -0.79524845, -2.9479933, -0.56865007, 0.56284213, -0.08927915, -0.8626236, -1.3537011, 0.254236, 0.9326776, -0.45368665, -2.0360966, 0.029971687, 0.63237894, -1.300345, -1.030171, 1.0722266, -2.007351, 0.8199897, 1.5832982, 0.15689406, 1.497932, 1.1177397, 2.06305, -0.74755156, 0.2565995, -0.05693402, 0.76637095, -0.2613934, -1.0536606, -0.87883437, 0.1296615, 0.9014519, -0.40080962, -1.2743711, -0.46013805, -0.42939487, -2.3930855, -1.8069068, 0.5739975, -0.08744939, 1.3287873, -0.67605996, -0.36636496, -1.0662296, 0.022735415, -0.93173456, 1.1957145, -0.047886785, -0.52056843, 2.2782795, 0.41879717, 0.35352528, 0.7905873, -0.694696, -0.037872095, -0.130888, -0.24055012, 2.5352306, 1.6809584, -0.4996769, 0.3686142, -0.9322733, -1.5323715, 1.0316118, 0.6954912, 1.0563064, 0.38490522, 0.6460886, -0.5605112, -0.46351996, 0.6074251, -1.3881794, -0.91807777, -0.096949644, 1.3092773, 0.42897305, 1.4425193, 0.72141004, 0.37091342, -0.04243785, 0.26511037, 0.5983671, 0.2644794, 0.33265483, -0.9748375, 0.014292852, 0.98954266, -0.5001216, 0.7122749, -0.21733524, -1.0297965, 1.3067622, 0.34184626, 1.4343764, 0.10675654, -0.6309908, 0.20488046, 0.030974373, -0.77566016, -0.46113804, -0.21613203, -0.66530156, 0.32858896, -2.0713456, -1.5743291, 1.0057228, 0.72191644, -0.5333771, -0.41350463, 1.7749388, 1.220602, -0.35612425, 0.05195254, 0.57648593, -0.7822317, -0.6235696, -0.452714, -0.8174999, -0.6126899, 0.25315872, 1.0054396, -1.2926638, -1.0885426, -1.0708004, -0.8814962, 0.3919137]           |2025-12-10 23:26:22.453|2025-12-10 23:26:30.005|\n",
      "|CO1.PCCNTR.2756337|POLITECNICO COLOMBIANO JAIME ISAZA CADAVID                      |Antioquia      |5464800.0     |0            |V1.86121700  |[-1.0450346, -0.6035242, 0.0057074097, -0.7737515, 0.5492948, -0.09121994, -0.44888407, 0.30441839, -1.5130955, -1.584319, 1.2157468, 0.07978698, 0.1073411, -0.77018356, 1.7753145, -0.25685427, -0.5679142, -0.5420372, -0.80411077, 0.38200775, 0.7875641, 0.068123475, 1.5681046, 0.9556638, 1.2504628, -1.125123, 0.6958062, -0.56911516, 0.517268, -1.4776462, -0.7252676, -0.5588616, 0.14359553, 0.6732788, 0.0901236, -1.2461748, -1.8583615, -0.27321061, -4.0005856, -1.5870444, -0.20545146, 1.3470564, -0.43746468, -1.0478736, 0.6075824, -1.0513538, 0.18006496, -0.0015627434, 0.30243737, -0.012615408, -0.72001415, 0.3726233, 0.44884148, 0.15038463, 1.0948613, 0.3066666, 0.028109584, 0.32871333, 0.30018136, 1.4105234, 1.8383391, -0.2979474, -0.19615035, -1.1003653, -0.73369694, 0.5240762, -0.9107855, 1.259235, 0.17159879, -0.6126748, -0.9385399, 0.23315908, 0.23278308, -0.30896527, -1.1537845, 0.020490967, 0.43220618, -0.07006994, 2.0095963, -0.5085862, -0.29858828, -0.3351406, -0.20549938, 0.3896607, 0.72176284, -0.028923208, -0.27886003, 0.043554768, 1.2182277, 0.13420948, 0.72943395, 0.89114964, -0.43585175, 1.189116, -0.044216394, 0.31377268, 0.3266448, 0.08077727, -0.18847506, 0.9311936, -0.501869, 0.122775994, -0.22387038, -0.10709096, 0.51742613, -1.9479356, -1.3733557, 0.7713878, -0.08145695, 0.41673836, -0.4375918, -0.026408114, 1.920139, 0.6351453, 0.10121403, 0.22893208, -0.8201783, -1.1377326, -1.6356053, 0.51740223, -0.009605089, 0.5676458, 1.9781992, -0.658445, -1.2575401, -1.4107405, -1.9101225, 1.6615071]|2025-12-10 23:26:22.955|2025-12-10 23:26:30.005|\n",
      "|CO1.PCCNTR.8115197|OFICINA DE CONTROL DISCIPLINARIO INTERNO DE JUZGAMIENTO         |Valle del Cauca|0.0           |0            |V1.80111600  |[-1.866925, 0.0075976807, -0.79524845, -2.9479933, -0.56865007, 0.56284213, -0.08927915, -0.8626236, -1.3537011, 0.254236, 0.9326776, -0.45368665, -2.0360966, 0.029971687, 0.63237894, -1.300345, -1.030171, 1.0722266, -2.007351, 0.8199897, 1.5832982, 0.15689406, 1.497932, 1.1177397, 2.06305, -0.74755156, 0.2565995, -0.05693402, 0.76637095, -0.2613934, -1.0536606, -0.87883437, 0.1296615, 0.9014519, -0.40080962, -1.2743711, -0.46013805, -0.42939487, -2.3930855, -1.8069068, 0.5739975, -0.08744939, 1.3287873, -0.67605996, -0.36636496, -1.0662296, 0.022735415, -0.93173456, 1.1957145, -0.047886785, -0.52056843, 2.2782795, 0.41879717, 0.35352528, 0.7905873, -0.694696, -0.037872095, -0.130888, -0.24055012, 2.5352306, 1.6809584, -0.4996769, 0.3686142, -0.9322733, -1.5323715, 1.0316118, 0.6954912, 1.0563064, 0.38490522, 0.6460886, -0.5605112, -0.46351996, 0.6074251, -1.3881794, -0.91807777, -0.096949644, 1.3092773, 0.42897305, 1.4425193, 0.72141004, 0.37091342, -0.04243785, 0.26511037, 0.5983671, 0.2644794, 0.33265483, -0.9748375, 0.014292852, 0.98954266, -0.5001216, 0.7122749, -0.21733524, -1.0297965, 1.3067622, 0.34184626, 1.4343764, 0.10675654, -0.6309908, 0.20488046, 0.030974373, -0.77566016, -0.46113804, -0.21613203, -0.66530156, 0.32858896, -2.0713456, -1.5743291, 1.0057228, 0.72191644, -0.5333771, -0.41350463, 1.7749388, 1.220602, -0.35612425, 0.05195254, 0.57648593, -0.7822317, -0.6235696, -0.452714, -0.8174999, -0.6126899, 0.25315872, 1.0054396, -1.2926638, -1.0885426, -1.0708004, -0.8814962, 0.3919137]           |2025-12-10 23:26:23.455|2025-12-10 23:26:30.005|\n",
      "|CO1.PCCNTR.7592638|EMPRESA SOCIAL DEL ESTADO HOSPITAL EL CARMEN 1                  |Antioquia      |0.0           |0            |V1.85101707  |[-1.866925, 0.0075976807, -0.79524845, -2.9479933, -0.56865007, 0.56284213, -0.08927915, -0.8626236, -1.3537011, 0.254236, 0.9326776, -0.45368665, -2.0360966, 0.029971687, 0.63237894, -1.300345, -1.030171, 1.0722266, -2.007351, 0.8199897, 1.5832982, 0.15689406, 1.497932, 1.1177397, 2.06305, -0.74755156, 0.2565995, -0.05693402, 0.76637095, -0.2613934, -1.0536606, -0.87883437, 0.1296615, 0.9014519, -0.40080962, -1.2743711, -0.46013805, -0.42939487, -2.3930855, -1.8069068, 0.5739975, -0.08744939, 1.3287873, -0.67605996, -0.36636496, -1.0662296, 0.022735415, -0.93173456, 1.1957145, -0.047886785, -0.52056843, 2.2782795, 0.41879717, 0.35352528, 0.7905873, -0.694696, -0.037872095, -0.130888, -0.24055012, 2.5352306, 1.6809584, -0.4996769, 0.3686142, -0.9322733, -1.5323715, 1.0316118, 0.6954912, 1.0563064, 0.38490522, 0.6460886, -0.5605112, -0.46351996, 0.6074251, -1.3881794, -0.91807777, -0.096949644, 1.3092773, 0.42897305, 1.4425193, 0.72141004, 0.37091342, -0.04243785, 0.26511037, 0.5983671, 0.2644794, 0.33265483, -0.9748375, 0.014292852, 0.98954266, -0.5001216, 0.7122749, -0.21733524, -1.0297965, 1.3067622, 0.34184626, 1.4343764, 0.10675654, -0.6309908, 0.20488046, 0.030974373, -0.77566016, -0.46113804, -0.21613203, -0.66530156, 0.32858896, -2.0713456, -1.5743291, 1.0057228, 0.72191644, -0.5333771, -0.41350463, 1.7749388, 1.220602, -0.35612425, 0.05195254, 0.57648593, -0.7822317, -0.6235696, -0.452714, -0.8174999, -0.6126899, 0.25315872, 1.0054396, -1.2926638, -1.0885426, -1.0708004, -0.8814962, 0.3919137]           |2025-12-10 23:26:23.956|2025-12-10 23:26:30.005|\n",
      "|CO1.PCCNTR.7520654|MUNICIPIO DE YUMBO VALLE                                        |Valle del Cauca|1.8E7         |0            |V1.80111601  |[-1.0264232, -0.5582893, -0.017091354, -0.03363017, 0.710863, 0.032533392, -0.35490713, 0.27008638, -1.6935666, -1.2524025, 1.0184525, 0.06852388, -0.09830882, -0.6074849, 1.615536, -0.5040251, -0.751381, -0.40040234, -1.1077794, 0.42293996, 0.86416686, 0.018198116, 1.1030351, 1.0941132, 1.4205525, -0.98294294, 0.6334626, -0.18701153, 0.45429128, -1.4135252, -0.631608, -1.0446763, 0.053630326, 0.6637998, 0.4942664, -1.1313825, -1.4235091, -0.14413343, -3.4411125, -1.5792891, -0.2952456, 1.1300887, -1.0844097, -0.8288753, 0.3513851, -1.3075068, -0.021286743, 0.0433222, 0.18958843, -0.46073267, -0.70042855, 0.70649004, 0.38248676, 0.187917, 0.9270351, 0.13739975, 0.4011823, 0.31774598, 0.24618106, 1.1611747, 1.8438752, -0.52334666, -0.24347381, -0.7288874, -0.61034423, 0.587353, -0.64767295, 0.8387374, 0.3697207, -0.22330137, -1.2948579, 0.42633107, 0.39958954, -0.29155627, -0.9977798, 0.42470196, 0.09205021, -0.023880977, 1.5486723, -0.53563875, -0.103114255, -0.5911416, -0.035961036, 0.5681962, 0.7966125, -0.12024224, -0.6486328, 0.04234015, 1.0863, -0.06569103, 0.9164451, 0.4262811, -0.71997124, 1.1289032, -0.34293818, 0.25339198, 0.527557, 0.26580584, -0.10266594, 0.78536296, -0.59277576, 0.27554384, -0.24772409, -0.3106585, 0.9589453, -1.5139108, -1.2352442, 0.7159199, -0.08720283, 0.3017781, -0.6669375, 0.20419085, 2.034952, 0.31337073, 0.0033520977, -0.1476857, -0.9447556, -0.47109354, -1.2312315, 0.3741404, 0.13014099, 0.89819926, 1.8002789, -0.82707596, -1.5152165, -1.3031379, -1.9888458, 1.5784333]      |2025-12-10 23:26:24.457|2025-12-10 23:26:30.005|\n",
      "|CO1.PCCNTR.3396655|ALCALDIA MUNICIPAL DE BUGA                                      |Valle del Cauca|0.0           |0            |V1.80111600  |[-1.866925, 0.0075976807, -0.79524845, -2.9479933, -0.56865007, 0.56284213, -0.08927915, -0.8626236, -1.3537011, 0.254236, 0.9326776, -0.45368665, -2.0360966, 0.029971687, 0.63237894, -1.300345, -1.030171, 1.0722266, -2.007351, 0.8199897, 1.5832982, 0.15689406, 1.497932, 1.1177397, 2.06305, -0.74755156, 0.2565995, -0.05693402, 0.76637095, -0.2613934, -1.0536606, -0.87883437, 0.1296615, 0.9014519, -0.40080962, -1.2743711, -0.46013805, -0.42939487, -2.3930855, -1.8069068, 0.5739975, -0.08744939, 1.3287873, -0.67605996, -0.36636496, -1.0662296, 0.022735415, -0.93173456, 1.1957145, -0.047886785, -0.52056843, 2.2782795, 0.41879717, 0.35352528, 0.7905873, -0.694696, -0.037872095, -0.130888, -0.24055012, 2.5352306, 1.6809584, -0.4996769, 0.3686142, -0.9322733, -1.5323715, 1.0316118, 0.6954912, 1.0563064, 0.38490522, 0.6460886, -0.5605112, -0.46351996, 0.6074251, -1.3881794, -0.91807777, -0.096949644, 1.3092773, 0.42897305, 1.4425193, 0.72141004, 0.37091342, -0.04243785, 0.26511037, 0.5983671, 0.2644794, 0.33265483, -0.9748375, 0.014292852, 0.98954266, -0.5001216, 0.7122749, -0.21733524, -1.0297965, 1.3067622, 0.34184626, 1.4343764, 0.10675654, -0.6309908, 0.20488046, 0.030974373, -0.77566016, -0.46113804, -0.21613203, -0.66530156, 0.32858896, -2.0713456, -1.5743291, 1.0057228, 0.72191644, -0.5333771, -0.41350463, 1.7749388, 1.220602, -0.35612425, 0.05195254, 0.57648593, -0.7822317, -0.6235696, -0.452714, -0.8174999, -0.6126899, 0.25315872, 1.0054396, -1.2926638, -1.0885426, -1.0708004, -0.8814962, 0.3919137]           |2025-12-10 23:26:24.958|2025-12-10 23:26:30.005|\n",
      "|CO1.PCCNTR.3922894|EMPRESA DE DESARROLLO URBANO Y RURAL DE DOSQUEBRADAS            |Risaralda      |0.0           |0            |V1.93141509  |[-1.866925, 0.0075976807, -0.79524845, -2.9479933, -0.56865007, 0.56284213, -0.08927915, -0.8626236, -1.3537011, 0.254236, 0.9326776, -0.45368665, -2.0360966, 0.029971687, 0.63237894, -1.300345, -1.030171, 1.0722266, -2.007351, 0.8199897, 1.5832982, 0.15689406, 1.497932, 1.1177397, 2.06305, -0.74755156, 0.2565995, -0.05693402, 0.76637095, -0.2613934, -1.0536606, -0.87883437, 0.1296615, 0.9014519, -0.40080962, -1.2743711, -0.46013805, -0.42939487, -2.3930855, -1.8069068, 0.5739975, -0.08744939, 1.3287873, -0.67605996, -0.36636496, -1.0662296, 0.022735415, -0.93173456, 1.1957145, -0.047886785, -0.52056843, 2.2782795, 0.41879717, 0.35352528, 0.7905873, -0.694696, -0.037872095, -0.130888, -0.24055012, 2.5352306, 1.6809584, -0.4996769, 0.3686142, -0.9322733, -1.5323715, 1.0316118, 0.6954912, 1.0563064, 0.38490522, 0.6460886, -0.5605112, -0.46351996, 0.6074251, -1.3881794, -0.91807777, -0.096949644, 1.3092773, 0.42897305, 1.4425193, 0.72141004, 0.37091342, -0.04243785, 0.26511037, 0.5983671, 0.2644794, 0.33265483, -0.9748375, 0.014292852, 0.98954266, -0.5001216, 0.7122749, -0.21733524, -1.0297965, 1.3067622, 0.34184626, 1.4343764, 0.10675654, -0.6309908, 0.20488046, 0.030974373, -0.77566016, -0.46113804, -0.21613203, -0.66530156, 0.32858896, -2.0713456, -1.5743291, 1.0057228, 0.72191644, -0.5333771, -0.41350463, 1.7749388, 1.220602, -0.35612425, 0.05195254, 0.57648593, -0.7822317, -0.6235696, -0.452714, -0.8174999, -0.6126899, 0.25315872, 1.0054396, -1.2926638, -1.0885426, -1.0708004, -0.8814962, 0.3919137]           |2025-12-10 23:26:25.458|2025-12-10 23:26:30.005|\n",
      "|CO1.PCCNTR.2028554|GOBERNACIÃ“N DE RISARALDA**                                      |Risaralda      |3341780.0     |0            |V1.72154043  |[-1.8758607, 0.020378852, -0.7806501, -2.9283504, -0.5626715, 0.54070556, -0.098488435, -0.89205104, -1.3403614, 0.25083345, 0.95236, -0.44212002, -2.0399444, 0.042054072, 0.6131396, -1.3015122, -1.0256288, 1.0824428, -1.9970655, 0.7865031, 1.5835531, 0.17474264, 1.4693758, 1.0934643, 2.023238, -0.7398539, 0.24529538, -0.056004606, 0.7719651, -0.27655014, -1.0251414, -0.89269525, 0.14262258, 0.91139627, -0.4138117, -1.2609034, -0.46581706, -0.42018303, -2.3577576, -1.8076316, 0.5554051, -0.074357264, 1.3247949, -0.684323, -0.37299404, -1.0687889, 0.044773363, -0.9699884, 1.211537, -0.05109221, -0.51790726, 2.313219, 0.42880714, 0.36274096, 0.76768917, -0.63743633, -0.009167562, -0.16172442, -0.24058184, 2.5053697, 1.6628846, -0.4793463, 0.37254587, -0.9574138, -1.5162199, 1.0511239, 0.6824277, 1.0594372, 0.36405793, 0.6341044, -0.58265233, -0.49713105, 0.6281648, -1.4075649, -0.9303037, -0.10535945, 1.3259228, 0.42778033, 1.4802058, 0.71991515, 0.36011922, -0.043843623, 0.29214883, 0.61310816, 0.22398768, 0.33182836, -0.9518627, 0.029310832, 0.9774835, -0.4677177, 0.6982551, -0.23044269, -1.0288407, 1.3020151, 0.32854235, 1.4405748, 0.09027541, -0.6259567, 0.22833946, 0.047220178, -0.7850919, -0.45440847, -0.21822433, -0.65541875, 0.3021785, -2.0509508, -1.5657663, 0.9807797, 0.73078406, -0.50315773, -0.40254247, 1.7187612, 1.2522386, -0.3518374, 0.026970075, 0.5666134, -0.7957505, -0.6168615, -0.48098415, -0.8295989, -0.59944654, 0.25997514, 1.001452, -1.2521082, -1.0996363, -1.0525088, -0.8717668, 0.382625]   |2025-12-10 23:26:25.959|2025-12-10 23:26:30.005|\n",
      "|CO1.PCCNTR.4609102|EMPRESA DE SERVICIOS PUBLICOS DE NATAGAIMA S.A. E.S.P           |Tolima         |5253500.0     |0            |V1.80111600  |[-1.3454689, -0.5270715, -0.15364985, -1.5020384, 0.23112325, 0.13375168, -0.48075342, -2.1616243E-4, -1.5536104, -1.2593421, 1.3620093, -0.27562407, -0.2728506, -0.49685133, 1.6719568, -0.501817, -0.679356, -0.19474646, -1.4437355, 0.52767974, 1.3045487, -0.04781322, 1.6077014, 1.0437176, 1.3863074, -0.6493854, 0.15389964, -0.111346014, 0.76501256, -0.9298761, -0.67782325, -0.74824315, 0.31606796, 0.3973187, 0.3052922, -1.300641, -1.6195061, -0.050527826, -3.5036533, -1.7826947, 0.08230089, 1.0525604, -0.04511549, -0.81160307, 0.6577874, -1.2725143, 0.37841418, 0.18497571, 0.7566642, -0.25482598, -1.1041644, 0.563034, 0.12904894, 0.38641396, 1.0265917, 0.4629027, 0.4014249, 0.53211564, -0.006662195, 1.490893, 1.783085, -0.18717206, -0.081700034, -1.1812738, -0.8645623, 0.59833056, -0.81443787, 1.1816689, 0.4412665, -0.26301515, -1.0592254, 0.20299158, 0.11806848, -0.9626154, -0.94671696, 0.2375559, 0.4498834, 0.0970703, 1.6197364, -3.3500328E-4, -0.14462061, -0.078857884, -0.23369175, 0.42750207, 0.858631, 0.2999525, -0.5425992, -0.15143561, 1.2272964, -0.24437764, 0.5937662, 0.5918139, -0.7616743, 1.1734704, 0.01495294, 0.20326439, 0.28359884, 0.19574738, -0.29281273, 0.6877938, -0.47147802, -0.17906162, -0.15002157, 0.13093118, 0.5779927, -2.1502159, -1.4874045, 0.76017976, -0.37875256, 0.3619806, -0.7788388, 0.180115, 1.9597323, -0.064337105, -0.09309976, 0.21328852, -0.8354103, -1.1595953, -1.5398328, 0.4493472, -0.052189615, 0.67831975, 2.2976854, -0.99418056, -1.2145807, -1.6184112, -1.4545802, 1.7280883]|2025-12-10 23:26:26.46 |2025-12-10 23:26:30.005|\n",
      "+------------------+----------------------------------------------------------------+---------------+--------------+-------------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------+-----------------------+\n",
      "only showing top 10 rows\n",
      "\n",
      "\n",
      "=== VECTOR SIZE (primeras 10 filas) \n",
      "+------------------+-----------+\n",
      "|id_contrato       |vector_size|\n",
      "+------------------+-----------+\n",
      "|CO1.PCCNTR.6277223|128        |\n",
      "|CO1.PCCNTR.3124784|128        |\n",
      "|CO1.PCCNTR.2756337|128        |\n",
      "|CO1.PCCNTR.8115197|128        |\n",
      "|CO1.PCCNTR.7592638|128        |\n",
      "|CO1.PCCNTR.7520654|128        |\n",
      "|CO1.PCCNTR.3396655|128        |\n",
      "|CO1.PCCNTR.3922894|128        |\n",
      "|CO1.PCCNTR.2028554|128        |\n",
      "|CO1.PCCNTR.4609102|128        |\n",
      "+------------------+-----------+\n",
      "only showing top 10 rows\n",
      "\n",
      "\n",
      "=== PRIMEROS VALORES DEL VECTOR\n",
      "+------------------+-----------------------------------------------------------------------------------------------------------------------------+\n",
      "|id_contrato       |primeros_valores                                                                                                             |\n",
      "+------------------+-----------------------------------------------------------------------------------------------------------------------------+\n",
      "|CO1.PCCNTR.6277223|[-1.866925, 0.0075976807, -0.79524845, -2.9479933, -0.56865007, 0.56284213, -0.08927915, -0.8626236, -1.3537011, 0.254236]   |\n",
      "|CO1.PCCNTR.3124784|[-1.866925, 0.0075976807, -0.79524845, -2.9479933, -0.56865007, 0.56284213, -0.08927915, -0.8626236, -1.3537011, 0.254236]   |\n",
      "|CO1.PCCNTR.2756337|[-1.0450346, -0.6035242, 0.0057074097, -0.7737515, 0.5492948, -0.09121994, -0.44888407, 0.30441839, -1.5130955, -1.584319]   |\n",
      "|CO1.PCCNTR.8115197|[-1.866925, 0.0075976807, -0.79524845, -2.9479933, -0.56865007, 0.56284213, -0.08927915, -0.8626236, -1.3537011, 0.254236]   |\n",
      "|CO1.PCCNTR.7592638|[-1.866925, 0.0075976807, -0.79524845, -2.9479933, -0.56865007, 0.56284213, -0.08927915, -0.8626236, -1.3537011, 0.254236]   |\n",
      "|CO1.PCCNTR.7520654|[-1.0264232, -0.5582893, -0.017091354, -0.03363017, 0.710863, 0.032533392, -0.35490713, 0.27008638, -1.6935666, -1.2524025]  |\n",
      "|CO1.PCCNTR.3396655|[-1.866925, 0.0075976807, -0.79524845, -2.9479933, -0.56865007, 0.56284213, -0.08927915, -0.8626236, -1.3537011, 0.254236]   |\n",
      "|CO1.PCCNTR.3922894|[-1.866925, 0.0075976807, -0.79524845, -2.9479933, -0.56865007, 0.56284213, -0.08927915, -0.8626236, -1.3537011, 0.254236]   |\n",
      "|CO1.PCCNTR.2028554|[-1.8758607, 0.020378852, -0.7806501, -2.9283504, -0.5626715, 0.54070556, -0.098488435, -0.89205104, -1.3403614, 0.25083345] |\n",
      "|CO1.PCCNTR.4609102|[-1.3454689, -0.5270715, -0.15364985, -1.5020384, 0.23112325, 0.13375168, -0.48075342, -2.1616243E-4, -1.5536104, -1.2593421]|\n",
      "+------------------+-----------------------------------------------------------------------------------------------------------------------------+\n",
      "only showing top 10 rows\n",
      "\n"
     ]
    }
   ],
   "source": [
    "from pyspark.sql.functions import slice, size\n",
    "\n",
    "# Cargar GOLD\n",
    "df_gold_check = spark.read.format(\"delta\").load(GOLD_DELTA_PATH)\n",
    "\n",
    "print(\"=== SCHEMA GOLD ===\")\n",
    "df_gold_check.printSchema()\n",
    "\n",
    "print(\"\\n=== SAMPLE ROWS (10) ===\")\n",
    "df_gold_check.show(10, truncate=False)\n",
    "\n",
    "print(\"\\n=== VECTOR SIZE (primeras 10 filas) \")\n",
    "df_gold_check.select(\n",
    "    \"id_contrato\",\n",
    "    size(\"objeto_embedding\").alias(\"vector_size\")\n",
    ").show(10, truncate=False)\n",
    "\n",
    "print(\"\\n=== PRIMEROS VALORES DEL VECTOR\")\n",
    "df_gold_check.select(\n",
    "    \"id_contrato\",\n",
    "    slice(\"objeto_embedding\", 1, 10).alias(\"primeros_valores\")\n",
    ").show(10, truncate=False)\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a0f311c7",
   "metadata": {},
   "source": [
    "## Variables CategÃ³ricas"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "f0778f1b",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ… Pipeline ML completo definido correctamente.\n"
     ]
    }
   ],
   "source": [
    "from pyspark.sql.functions import col, udf\n",
    "from pyspark.sql.types import ArrayType, FloatType\n",
    "from pyspark.ml.linalg import DenseVector, VectorUDT\n",
    "\n",
    "from pyspark.ml.feature import StringIndexer, OneHotEncoder, VectorAssembler\n",
    "from pyspark.ml import Pipeline\n",
    "\n",
    "# 1. Leer GOLD\n",
    "GOLD_DELTA_PATH = \"/opt/spark/data/delta/gold_contracts\"\n",
    "df_gold_base = spark.read.format(\"delta\").load(GOLD_DELTA_PATH)\n",
    "\n",
    "# =====================================================\n",
    "# A. Convertir array<float> â†’ DenseVector (obligatorio)\n",
    "# =====================================================\n",
    "\n",
    "def to_dense_vector(arr):\n",
    "    if arr is None:\n",
    "        return None\n",
    "    return DenseVector(arr)\n",
    "\n",
    "to_dense_udf = udf(to_dense_vector, VectorUDT())\n",
    "\n",
    "df_gold_vec = df_gold_base.withColumn(\n",
    "    \"objeto_embedding_vec\",\n",
    "    to_dense_udf(col(\"objeto_embedding\"))\n",
    ")\n",
    "\n",
    "# =====================================================\n",
    "# B. StringIndexer\n",
    "# =====================================================\n",
    "\n",
    "indexer_entidad = StringIndexer(\n",
    "    inputCol=\"entidad\",\n",
    "    outputCol=\"entidad_indexed\",\n",
    "    handleInvalid=\"keep\"\n",
    ")\n",
    "\n",
    "indexer_unspsc = StringIndexer(\n",
    "    inputCol=\"codigo_unspsc\",\n",
    "    outputCol=\"unspsc_indexed\",\n",
    "    handleInvalid=\"keep\"\n",
    ")\n",
    "\n",
    "# =====================================================\n",
    "# C. OneHotEncoder\n",
    "# =====================================================\n",
    "\n",
    "encoder_entidad = OneHotEncoder(\n",
    "    inputCol=\"entidad_indexed\",\n",
    "    outputCol=\"entidad_encoded\"\n",
    ")\n",
    "\n",
    "encoder_unspsc = OneHotEncoder(\n",
    "    inputCol=\"unspsc_indexed\",\n",
    "    outputCol=\"unspsc_encoded\"\n",
    ")\n",
    "\n",
    "# =====================================================\n",
    "# D. VectorAssembler (incluye embeddings + numÃ©ricas)\n",
    "# =====================================================\n",
    "\n",
    "feature_cols = [\n",
    "    \"objeto_embedding_vec\",   # â† EL BUENO\n",
    "    \"entidad_encoded\",\n",
    "    \"unspsc_encoded\",\n",
    "    \"valor_contrato\",\n",
    "    \"duracion_dias\"\n",
    "]\n",
    "\n",
    "assembler = VectorAssembler(\n",
    "    inputCols=feature_cols,\n",
    "    outputCol=\"features_final\"\n",
    ")\n",
    "\n",
    "# =====================================================\n",
    "# E. Pipeline final\n",
    "# =====================================================\n",
    "\n",
    "ml_pipeline = Pipeline(stages=[\n",
    "    indexer_entidad,\n",
    "    encoder_entidad,\n",
    "    indexer_unspsc,\n",
    "    encoder_unspsc,\n",
    "    assembler\n",
    "])\n",
    "\n",
    "print(\"âœ… Pipeline ML completo definido correctamente.\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "dac08e64",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                "
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "--- ESQUEMA FINAL CON LAS NUEVAS FEATURES ---\n",
      "root\n",
      " |-- id_contrato: string (nullable = true)\n",
      " |-- entidad: string (nullable = true)\n",
      " |-- departamento: string (nullable = true)\n",
      " |-- valor_contrato: double (nullable = true)\n",
      " |-- duracion_dias: long (nullable = true)\n",
      " |-- codigo_unspsc: string (nullable = true)\n",
      " |-- objeto_embedding: array (nullable = true)\n",
      " |    |-- element: float (containsNull = true)\n",
      " |-- kafka_ingestion_time: timestamp (nullable = true)\n",
      " |-- processing_time: timestamp (nullable = true)\n",
      " |-- objeto_embedding_vec: vector (nullable = true)\n",
      " |-- entidad_indexed: double (nullable = false)\n",
      " |-- entidad_encoded: vector (nullable = true)\n",
      " |-- unspsc_indexed: double (nullable = false)\n",
      " |-- unspsc_encoded: vector (nullable = true)\n",
      " |-- features_final: vector (nullable = true)\n",
      "\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                "
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n",
      "|id_contrato       |features_final                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |\n",
      "+------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n",
      "|CO1.PCCNTR.4107445|(1426,[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,292,720,1424],[-1.8860232830047607,0.0026308943051844835,-0.8086512088775635,-2.966787338256836,-0.58037930727005,0.5589082837104797,-0.0739390179514885,-0.821782648563385,-1.3494365215301514,0.25554734468460083,0.9146221280097961,-0.4349451959133148,-2.04337739944458,0.057268865406513214,0.6123584508895874,-1.284177303314209,-1.043824553489685,1.0687921047210693,-1.9571465253829956,0.8316329121589661,1.5902355909347534,0.1170603558421135,1.4939830303192139,1.070974349975586,2.0564723014831543,-0.747732400894165,0.2669183015823364,-0.06717231124639511,0.7746117115020752,-0.27796459197998047,-1.075846552848816,-0.890299379825592,0.11481712758541107,0.9100303053855896,-0.4265126883983612,-1.2195470333099365,-0.4466283321380615,-0.43472930788993835,-2.368403196334839,-1.8109081983566284,0.5530247092247009,-0.08799907565116882,1.3581470251083374,-0.6557179093360901,-0.37913522124290466,-1.0729621648788452,-0.0091997180134058,-0.9106327891349792,1.1786212921142578,-0.014218865893781185,-0.5744653344154358,2.24003267288208,0.44088611006736755,0.36767786741256714,0.7895290851593018,-0.722716748714447,-0.023729762062430382,-0.11712358891963959,-0.220624178647995,2.5378663539886475,1.682400107383728,-0.5006560683250427,0.3273409605026245,-0.9430036544799805,-1.5264700651168823,1.019754409790039,0.7109763622283936,1.0881121158599854,0.3886597454547882,0.6679332852363586,-0.5504703521728516,-0.44951125979423523,0.6226183772087097,-1.3887852430343628,-0.9202147722244263,-0.08815179765224457,1.3154181241989136,0.4636926054954529,1.4363830089569092,0.7629474401473999,0.3638232946395874,-0.07317519932985306,0.2711266279220581,0.5690600275993347,0.2578512728214264,0.3864724934101105,-0.9686618447303772,0.02350061945617199,0.9971098303794861,-0.4842296242713928,0.7041099071502686,-0.25519663095474243,-1.009880542755127,1.3223737478256226,0.33057698607444763,1.4100792407989502,0.1101151779294014,-0.6646600961685181,0.23447732627391815,0.04343358799815178,-0.7980131506919861,-0.4642375409603119,-0.20178312063217163,-0.6572542786598206,0.3179002106189728,-2.1437151432037354,-1.5394195318222046,1.0235469341278076,0.7128925919532776,-0.5424647331237793,-0.4505544900894165,1.8375439643859863,1.2171510457992554,-0.3729909062385559,0.06117916852235794,0.5730127692222595,-0.7630887031555176,-0.6030640602111816,-0.44033217430114746,-0.8023417592048645,-0.5909487009048462,0.27257364988327026,0.9973085522651672,-1.3503832817077637,-1.1114532947540283,-1.1036838293075562,-0.8913924098014832,0.36491814255714417,1.0,1.0,9772584.0])          |\n",
      "|CO1.PCCNTR.4166835|(1426,[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,465,747,1424],[-1.8860232830047607,0.0026308943051844835,-0.8086512088775635,-2.966787338256836,-0.58037930727005,0.5589082837104797,-0.0739390179514885,-0.821782648563385,-1.3494365215301514,0.25554734468460083,0.9146221280097961,-0.4349451959133148,-2.04337739944458,0.057268865406513214,0.6123584508895874,-1.284177303314209,-1.043824553489685,1.0687921047210693,-1.9571465253829956,0.8316329121589661,1.5902355909347534,0.1170603558421135,1.4939830303192139,1.070974349975586,2.0564723014831543,-0.747732400894165,0.2669183015823364,-0.06717231124639511,0.7746117115020752,-0.27796459197998047,-1.075846552848816,-0.890299379825592,0.11481712758541107,0.9100303053855896,-0.4265126883983612,-1.2195470333099365,-0.4466283321380615,-0.43472930788993835,-2.368403196334839,-1.8109081983566284,0.5530247092247009,-0.08799907565116882,1.3581470251083374,-0.6557179093360901,-0.37913522124290466,-1.0729621648788452,-0.0091997180134058,-0.9106327891349792,1.1786212921142578,-0.014218865893781185,-0.5744653344154358,2.24003267288208,0.44088611006736755,0.36767786741256714,0.7895290851593018,-0.722716748714447,-0.023729762062430382,-0.11712358891963959,-0.220624178647995,2.5378663539886475,1.682400107383728,-0.5006560683250427,0.3273409605026245,-0.9430036544799805,-1.5264700651168823,1.019754409790039,0.7109763622283936,1.0881121158599854,0.3886597454547882,0.6679332852363586,-0.5504703521728516,-0.44951125979423523,0.6226183772087097,-1.3887852430343628,-0.9202147722244263,-0.08815179765224457,1.3154181241989136,0.4636926054954529,1.4363830089569092,0.7629474401473999,0.3638232946395874,-0.07317519932985306,0.2711266279220581,0.5690600275993347,0.2578512728214264,0.3864724934101105,-0.9686618447303772,0.02350061945617199,0.9971098303794861,-0.4842296242713928,0.7041099071502686,-0.25519663095474243,-1.009880542755127,1.3223737478256226,0.33057698607444763,1.4100792407989502,0.1101151779294014,-0.6646600961685181,0.23447732627391815,0.04343358799815178,-0.7980131506919861,-0.4642375409603119,-0.20178312063217163,-0.6572542786598206,0.3179002106189728,-2.1437151432037354,-1.5394195318222046,1.0235469341278076,0.7128925919532776,-0.5424647331237793,-0.4505544900894165,1.8375439643859863,1.2171510457992554,-0.3729909062385559,0.06117916852235794,0.5730127692222595,-0.7630887031555176,-0.6030640602111816,-0.44033217430114746,-0.8023417592048645,-0.5909487009048462,0.27257364988327026,0.9973085522651672,-1.3503832817077637,-1.1114532947540283,-1.1036838293075562,-0.8913924098014832,0.36491814255714417,1.0,1.0,2.3708356E7])        |\n",
      "|CO1.PCCNTR.1010730|(1426,[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,254,737,1424],[-1.1253693103790283,-0.36891016364097595,-0.20037876069545746,-0.015137558802962303,0.504672646522522,0.1521327793598175,-0.7094866633415222,0.5641490817070007,-1.4777041673660278,-1.6784273386001587,1.1575769186019897,0.05416262149810791,-0.14920896291732788,-0.3630627989768982,1.2866714000701904,-0.5542970299720764,-0.4476480484008789,-0.49309760332107544,-1.1204639673233032,0.34155160188674927,0.8284876346588135,0.12273945659399033,1.414668321609497,0.717605710029602,1.2163429260253906,-0.7602862119674683,0.512057363986969,-0.4692688584327698,0.20897305011749268,-1.2412950992584229,-0.8643237948417664,-1.1413129568099976,0.17631223797798157,0.4428460896015167,0.14451228082180023,-1.1891669034957886,-1.362141728401184,-0.05729701742529869,-3.0056076049804688,-1.67277991771698,-0.1631002575159073,1.2166317701339722,-1.0538880825042725,-0.968367338180542,0.5476645231246948,-1.5602370500564575,0.4023003578186035,-0.20421484112739563,0.345294713973999,0.06584460288286209,-0.935502827167511,0.4886219799518585,0.4740935266017914,0.3302597999572754,0.72709721326828,0.07800516486167908,0.2122715413570404,0.10819978266954422,0.03529413044452667,1.3362720012664795,1.7626879215240479,-0.4568406045436859,-0.24690048396587372,-1.0000513792037964,-0.9067915678024292,0.5657084584236145,-0.5119523406028748,1.4676088094711304,0.449810266494751,-0.23698970675468445,-1.1855510473251343,0.4796392619609833,0.2846207320690155,-0.5898331999778748,-0.4507874548435211,0.3612421751022339,0.3228144645690918,-0.08863173425197601,1.6984784603118896,-0.2993726134300232,-0.11102797836065292,-0.35649585723876953,-0.14218685030937195,0.2093140035867691,0.6847599744796753,-0.13718125224113464,-0.39182940125465393,-0.19218319654464722,1.2345309257507324,0.256903737783432,0.7113232016563416,0.5712573528289795,-0.2077588438987732,1.13906991481781,-0.12017948180437088,0.40215587615966797,0.7246231436729431,0.6981440186500549,-0.14895890653133392,0.6405518651008606,-0.16245627403259277,0.20134574174880981,-0.24965092539787292,-0.08563476800918579,0.7294137477874756,-1.8502850532531738,-1.5637321472167969,0.7696002125740051,0.18983237445354462,0.19435644149780273,-0.7932489514350891,-0.30642715096473694,2.005840539932251,0.21955879032611847,-0.1872677356004715,0.22809875011444092,-1.0834627151489258,-0.6686997413635254,-1.4647111892700195,0.2427319437265396,-0.13022546470165253,1.0095882415771484,1.9160131216049194,-1.026865839958191,-1.511810541152954,-1.219150185585022,-1.9590123891830444,1.786810278892517,1.0,1.0,6.0E8])         |\n",
      "|CO1.PCCNTR.6882867|(1426,[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,138,703],[-1.8860232830047607,0.0026308943051844835,-0.8086512088775635,-2.966787338256836,-0.58037930727005,0.5589082837104797,-0.0739390179514885,-0.821782648563385,-1.3494365215301514,0.25554734468460083,0.9146221280097961,-0.4349451959133148,-2.04337739944458,0.057268865406513214,0.6123584508895874,-1.284177303314209,-1.043824553489685,1.0687921047210693,-1.9571465253829956,0.8316329121589661,1.5902355909347534,0.1170603558421135,1.4939830303192139,1.070974349975586,2.0564723014831543,-0.747732400894165,0.2669183015823364,-0.06717231124639511,0.7746117115020752,-0.27796459197998047,-1.075846552848816,-0.890299379825592,0.11481712758541107,0.9100303053855896,-0.4265126883983612,-1.2195470333099365,-0.4466283321380615,-0.43472930788993835,-2.368403196334839,-1.8109081983566284,0.5530247092247009,-0.08799907565116882,1.3581470251083374,-0.6557179093360901,-0.37913522124290466,-1.0729621648788452,-0.0091997180134058,-0.9106327891349792,1.1786212921142578,-0.014218865893781185,-0.5744653344154358,2.24003267288208,0.44088611006736755,0.36767786741256714,0.7895290851593018,-0.722716748714447,-0.023729762062430382,-0.11712358891963959,-0.220624178647995,2.5378663539886475,1.682400107383728,-0.5006560683250427,0.3273409605026245,-0.9430036544799805,-1.5264700651168823,1.019754409790039,0.7109763622283936,1.0881121158599854,0.3886597454547882,0.6679332852363586,-0.5504703521728516,-0.44951125979423523,0.6226183772087097,-1.3887852430343628,-0.9202147722244263,-0.08815179765224457,1.3154181241989136,0.4636926054954529,1.4363830089569092,0.7629474401473999,0.3638232946395874,-0.07317519932985306,0.2711266279220581,0.5690600275993347,0.2578512728214264,0.3864724934101105,-0.9686618447303772,0.02350061945617199,0.9971098303794861,-0.4842296242713928,0.7041099071502686,-0.25519663095474243,-1.009880542755127,1.3223737478256226,0.33057698607444763,1.4100792407989502,0.1101151779294014,-0.6646600961685181,0.23447732627391815,0.04343358799815178,-0.7980131506919861,-0.4642375409603119,-0.20178312063217163,-0.6572542786598206,0.3179002106189728,-2.1437151432037354,-1.5394195318222046,1.0235469341278076,0.7128925919532776,-0.5424647331237793,-0.4505544900894165,1.8375439643859863,1.2171510457992554,-0.3729909062385559,0.06117916852235794,0.5730127692222595,-0.7630887031555176,-0.6030640602111816,-0.44033217430114746,-0.8023417592048645,-0.5909487009048462,0.27257364988327026,0.9973085522651672,-1.3503832817077637,-1.1114532947540283,-1.1036838293075562,-0.8913924098014832,0.36491814255714417,1.0,1.0])                         |\n",
      "|CO1.PCCNTR.1320398|(1426,[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,166,700],[-0.9961177110671997,-0.6200743913650513,-0.09964273869991302,-0.43292510509490967,0.35618096590042114,0.12274691462516785,-0.3919331133365631,0.3027642071247101,-1.9887652397155762,-1.540770173072815,0.7939097881317139,0.32897481322288513,0.22991730272769928,-0.5405992865562439,1.567604660987854,-0.5698397755622864,-0.691358208656311,-0.5277528166770935,-0.8319675922393799,0.6747332215309143,1.0869189500808716,0.02009899914264679,1.194069504737854,0.7349483966827393,1.5088242292404175,-0.9693818688392639,0.21511220932006836,-0.5913557410240173,0.5096503496170044,-1.1198979616165161,-0.5888872742652893,-0.8409562706947327,0.28325188159942627,0.40599939227104187,0.22076599299907684,-1.0960713624954224,-1.6424181461334229,-0.13198821246623993,-3.241699695587158,-1.6178169250488281,-0.04547081142663956,1.4590662717819214,-0.7431756258010864,-0.7645286321640015,0.5210559964179993,-1.2961294651031494,0.031002314761281013,0.2129661589860916,0.4446201026439667,0.06845252960920334,-0.695233166217804,1.253442406654358,0.3625054657459259,-0.015551624819636345,0.8446516990661621,0.039820171892642975,0.33184492588043213,0.6018043160438538,0.4789746105670929,1.5215624570846558,1.813489317893982,-0.3974016606807709,-0.21493422985076904,-0.9946817755699158,-0.7745402455329895,0.5457803606987,-0.8774358630180359,0.9781497120857239,0.18998177349567413,-0.6287012696266174,-0.9785821437835693,0.32213088870048523,0.5131308436393738,-0.47537460923194885,-0.9919511079788208,0.45862534642219543,0.3439894914627075,0.019209399819374084,1.4713863134384155,-0.5202845931053162,-0.47623392939567566,-0.3898884952068329,-0.06734028458595276,0.4115656316280365,0.4430769383907318,-0.09817158430814743,-0.09953536093235016,-0.06101522594690323,1.3610855340957642,-0.08734963089227676,0.6999240517616272,0.3384753167629242,-0.3446015417575836,1.3511245250701904,-0.365496963262558,0.40484514832496643,0.41888195276260376,-0.11036216467618942,-0.17152483761310577,0.9014484882354736,-0.42656609416007996,-0.004324314650148153,-0.2975234091281891,0.011175410822033882,0.8034265041351318,-2.1312382221221924,-1.420762062072754,0.4719259738922119,-0.16900603473186493,0.15139546990394592,-0.4497963786125183,-0.005883687175810337,1.8966017961502075,0.24410836398601532,-0.016337793320417404,0.20740868151187897,-0.7136683464050293,-0.9937988519668579,-1.3436297178268433,0.2988812029361725,-0.06276699155569077,0.8329648971557617,1.7894957065582275,-0.6162242889404297,-1.2870769500732422,-1.5095329284667969,-1.8366769552230835,1.985190510749817,1.0,1.0])|\n",
      "+------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n",
      "only showing top 5 rows\n",
      "\n"
     ]
    }
   ],
   "source": [
    "ml_pipeline_model = ml_pipeline.fit(df_gold_vec)\n",
    "df_ml_ready = ml_pipeline_model.transform(df_gold_vec)\n",
    "\n",
    "\n",
    "# ----------------------------------------------------\n",
    "# VERIFICACIÃ“N DE RESULTADOS\n",
    "# ----------------------------------------------------\n",
    "print(\"\\n--- ESQUEMA FINAL CON LAS NUEVAS FEATURES ---\")\n",
    "# Busca las columnas 'entidad_indexed', 'entidad_encoded' y 'features_final'\n",
    "df_ml_ready.printSchema()\n",
    "\n",
    "df_ml_ready.select(\n",
    "    \"id_contrato\",\n",
    "    \"features_final\"\n",
    ").show(5, truncate=False)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "717424fd-5562-4634-b0fa-2cb29cd2693c",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "12e21d10-1d6c-472e-97d6-9c05e982f94d",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "b5e4be0c-a292-4f3c-a708-c7b862b1a8f2",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "[Stage 448:>                                                        (0 + 1) / 1]"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ” Embeddings nulos reemplazados por vector de ceros\n",
      "âœ” Columnas numÃ©ricas rellenadas con mediana\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                "
     ]
    }
   ],
   "source": [
    "from pyspark.sql.functions import col, when, lit\n",
    "from pyspark.ml.functions import vector_to_array\n",
    "from pyspark.sql import functions as F\n",
    "\n",
    "# ================================\n",
    "# 1. REPARAR NULOS EN NUMÃ‰RICAS\n",
    "# ================================\n",
    "# calcular medianas\n",
    "median_vals = {}\n",
    "for c in [\"valor_contrato\", \"duracion_dias\"]:\n",
    "    median_vals[c] = df_ml_ready.approxQuantile(c, [0.5], 0.001)[0]\n",
    "\n",
    "df_clean = df_ml_ready.fillna(median_vals)\n",
    "\n",
    "# ================================\n",
    "# 2. REPARAR NULOS EN EMBEDDINGS\n",
    "# ================================\n",
    "# convertir embedding a array para revisar\n",
    "df_clean = df_clean.withColumn(\"embed_arr_tmp\", vector_to_array(col(\"objeto_embedding_vec\")))\n",
    "\n",
    "# detectar tamaÃ±o del embedding\n",
    "first = df_clean.select(\"embed_arr_tmp\").filter(col(\"embed_arr_tmp\").isNotNull()).limit(1).collect()\n",
    "if len(first) == 0:\n",
    "    raise ValueError(\"No hay embeddings vÃ¡lidos para detectar longitud\")\n",
    "\n",
    "embed_dim = len(first[0][\"embed_arr_tmp\"])\n",
    "\n",
    "# vector de ceros\n",
    "zeros_array = [0.0] * embed_dim\n",
    "\n",
    "df_clean = df_clean.withColumn(\n",
    "    \"embed_arr\",\n",
    "    when(col(\"embed_arr_tmp\").isNull(), F.array([lit(0.0) for _ in range(embed_dim)]))\n",
    "    .otherwise(col(\"embed_arr_tmp\"))\n",
    ")\n",
    "\n",
    "# convertir a vector denso otra vez\n",
    "from pyspark.ml.linalg import DenseVector, VectorUDT\n",
    "from pyspark.sql.functions import udf\n",
    "\n",
    "def arr_to_vec(arr):\n",
    "    return DenseVector(arr)\n",
    "\n",
    "arr_to_vec_udf = udf(arr_to_vec, VectorUDT())\n",
    "\n",
    "df_clean = df_clean.withColumn(\"objeto_embedding_vec_fixed\", arr_to_vec_udf(col(\"embed_arr\")))\n",
    "\n",
    "# eliminamos columnas temporales\n",
    "df_clean = df_clean.drop(\"embed_arr_tmp\", \"objeto_embedding_vec\")\n",
    "\n",
    "df_clean = df_clean.withColumnRenamed(\"objeto_embedding_vec_fixed\", \"objeto_embedding_vec\")\n",
    "\n",
    "print(\"âœ” Embeddings nulos reemplazados por vector de ceros\")\n",
    "print(\"âœ” Columnas numÃ©ricas rellenadas con mediana\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "b4fa2cf0-6d76-4d26-9b4e-4d1c7d57fb77",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== CORRELACIÃ“N PEARSON CONTRA valor_contrato ===\n",
      "\n",
      "Variable: duracion_dias\n",
      "  Pearson : nan\n",
      "\n",
      "Variable: entidad_indexed\n",
      "  Pearson : 0.043927465354187754\n",
      "\n",
      "Variable: unspsc_indexed\n",
      "  Pearson : -0.0043034451977040505\n"
     ]
    }
   ],
   "source": [
    "from pyspark.sql.functions import corr\n",
    "\n",
    "numeric_vars = [\n",
    "    \"duracion_dias\",\n",
    "    \"entidad_indexed\",\n",
    "    \"unspsc_indexed\"\n",
    "]\n",
    "\n",
    "print(\"=== CORRELACIÃ“N PEARSON CONTRA valor_contrato ===\")\n",
    "\n",
    "for colname in numeric_vars:\n",
    "    pear = df_clean.stat.corr(colname, \"valor_contrato\")   # â† sin method\n",
    "    print(f\"\\nVariable: {colname}\")\n",
    "    print(f\"  Pearson : {pear}\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "fcdd34a5-882d-43d9-aa2f-b30b27c249de",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "=== SPEARMAN REAL ===\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "25/12/12 14:57:08 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:08 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:08 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:08 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:08 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:08 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:08 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:08 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "duracion_dias â†’ Spearman = nan\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "25/12/12 14:57:08 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:08 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:08 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:08 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:08 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:08 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:08 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:08 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "entidad_indexed â†’ Spearman = -0.061721289129798\n",
      "unspsc_indexed â†’ Spearman = 0.17464758085912319\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "25/12/12 14:57:09 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:09 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:09 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:09 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:09 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:09 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:09 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n",
      "25/12/12 14:57:09 WARN WindowExec: No Partition Defined for Window operation! Moving all data to a single partition, this can cause serious performance degradation.\n"
     ]
    }
   ],
   "source": [
    "from pyspark.sql import functions as F\n",
    "from pyspark.sql.window import Window\n",
    "\n",
    "def spearman_corr(df, col1, col2):\n",
    "    w = Window.orderBy(col1)\n",
    "    df_ranked = df.withColumn(\"r1\", F.rank().over(w))\n",
    "    \n",
    "    w2 = Window.orderBy(col2)\n",
    "    df_ranked = df_ranked.withColumn(\"r2\", F.rank().over(w2))\n",
    "    \n",
    "    # correlaciÃ³n pearson de los rangos\n",
    "    return df_ranked.stat.corr(\"r1\", \"r2\")\n",
    "\n",
    "print(\"\\n=== SPEARMAN REAL ===\")\n",
    "for colname in numeric_vars:\n",
    "    spear = spearman_corr(df_clean.select(colname, \"valor_contrato\"), colname, \"valor_contrato\")\n",
    "    print(f\"{colname} â†’ Spearman = {spear}\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "id": "14c9a9e0-12c2-4714-969d-e493b7192dbb",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                "
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ” VectorAssembler para PCA generado\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "25/12/12 14:59:25 WARN InstanceBuilder: Failed to load implementation from:dev.ludovic.netlib.lapack.JNILAPACK\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ” PCA aplicado correctamente\n",
      "\n",
      "===== VARIANZA EXPLICADA POR CADA COMPONENTE =====\n",
      "PC1: 1.0000\n",
      "PC2: 0.0000\n",
      "PC3: 0.0000\n",
      "PC4: 0.0000\n",
      "PC5: 0.0000\n",
      "PC6: 0.0000\n",
      "PC7: 0.0000\n",
      "PC8: 0.0000\n",
      "PC9: 0.0000\n",
      "PC10: 0.0000\n",
      "PC11: 0.0000\n",
      "PC12: 0.0000\n",
      "PC13: 0.0000\n",
      "PC14: 0.0000\n",
      "PC15: 0.0000\n",
      "PC16: 0.0000\n",
      "PC17: 0.0000\n",
      "PC18: 0.0000\n",
      "PC19: 0.0000\n",
      "PC20: 0.0000\n",
      "PC21: 0.0000\n",
      "PC22: 0.0000\n",
      "PC23: 0.0000\n",
      "PC24: 0.0000\n",
      "PC25: 0.0000\n",
      "PC26: 0.0000\n",
      "PC27: 0.0000\n",
      "PC28: 0.0000\n",
      "PC29: 0.0000\n",
      "PC30: 0.0000\n",
      "PC31: 0.0000\n",
      "PC32: 0.0000\n",
      "PC33: 0.0000\n",
      "PC34: 0.0000\n",
      "PC35: 0.0000\n",
      "PC36: 0.0000\n",
      "PC37: 0.0000\n",
      "PC38: 0.0000\n",
      "PC39: 0.0000\n",
      "PC40: 0.0000\n",
      "PC41: 0.0000\n",
      "PC42: 0.0000\n",
      "PC43: 0.0000\n",
      "PC44: 0.0000\n",
      "PC45: 0.0000\n",
      "PC46: 0.0000\n",
      "PC47: 0.0000\n",
      "PC48: 0.0000\n",
      "PC49: 0.0000\n",
      "PC50: 0.0000\n",
      "\n",
      "Varianza total explicada: 0.9999999999997313\n",
      "\n",
      "===== PREVIEW FINAL =====\n",
      "+------------------+--------------+--------------------+\n",
      "|       id_contrato|valor_contrato|        pca_features|\n",
      "+------------------+--------------+--------------------+\n",
      "|CO1.PCCNTR.4107445|     9772584.0|[-9772584.0,5.744...|\n",
      "|CO1.PCCNTR.4166835|   2.3708356E7|[-2.3708356E7,5.7...|\n",
      "|CO1.PCCNTR.1010730|         6.0E8|[-6.0E8,-2.768756...|\n",
      "|CO1.PCCNTR.6882867|           0.0|[3.25349238886578...|\n",
      "|CO1.PCCNTR.1320398|           0.0|[-1.9118044916786...|\n",
      "+------------------+--------------+--------------------+\n",
      "only showing top 5 rows\n",
      "\n"
     ]
    }
   ],
   "source": [
    "from pyspark.ml.feature import PCA\n",
    "# ======================================================\n",
    "# 3. VECTOR ASSEMBLER PARA PCA\n",
    "# ======================================================\n",
    "\n",
    "assembler_pca = VectorAssembler(\n",
    "    inputCols=[\n",
    "        \"valor_contrato\",\n",
    "        \"duracion_dias\",\n",
    "        \"entidad_encoded\",\n",
    "        \"unspsc_encoded\",\n",
    "        \"objeto_embedding_vec\"\n",
    "    ],\n",
    "    outputCol=\"pca_input\"\n",
    ")\n",
    "\n",
    "df_pca_ready = assembler_pca.transform(df_clean)\n",
    "print(\"âœ” VectorAssembler para PCA generado\")\n",
    "\n",
    "\n",
    "# ======================================================\n",
    "# 4. PCA\n",
    "# ======================================================\n",
    "\n",
    "pca = PCA(\n",
    "    k=50,   # nÃºmero de componentes\n",
    "    inputCol=\"pca_input\",\n",
    "    outputCol=\"pca_features\"\n",
    ")\n",
    "\n",
    "model_pca = pca.fit(df_pca_ready)\n",
    "df_pca = model_pca.transform(df_pca_ready)\n",
    "\n",
    "print(\"âœ” PCA aplicado correctamente\")\n",
    "\n",
    "\n",
    "# ======================================================\n",
    "# 5. VARIANZA EXPLICADA\n",
    "# ======================================================\n",
    "\n",
    "explained = model_pca.explainedVariance.toArray()\n",
    "\n",
    "print(\"\\n===== VARIANZA EXPLICADA POR CADA COMPONENTE =====\")\n",
    "for i, v in enumerate(explained):\n",
    "    print(f\"PC{i+1}: {v:.4f}\")\n",
    "\n",
    "print(\"\\nVarianza total explicada:\", sum(explained))\n",
    "\n",
    "\n",
    "# ======================================================\n",
    "# 6. DATASET FINAL LISTO PARA MODELAR\n",
    "# ======================================================\n",
    "\n",
    "df_final = df_pca.select(\n",
    "    \"id_contrato\",\n",
    "    \"valor_contrato\",\n",
    "    \"pca_features\"\n",
    ")\n",
    "\n",
    "print(\"\\n===== PREVIEW FINAL =====\")\n",
    "df_final.show(5)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "id": "c057292c-39a5-427c-be43-c6dc80d04058",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ” Split realizado:\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                "
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Train: 4771 filas\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                "
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Test:  1120 filas\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "25/12/12 14:59:46 WARN DAGScheduler: Broadcasting large task binary with size 1005.0 KiB\n",
      "25/12/12 14:59:50 WARN DAGScheduler: Broadcasting large task binary with size 1005.8 KiB\n",
      "25/12/12 14:59:51 WARN DAGScheduler: Broadcasting large task binary with size 1006.5 KiB\n",
      "25/12/12 14:59:51 WARN DAGScheduler: Broadcasting large task binary with size 1007.5 KiB\n",
      "25/12/12 14:59:51 WARN DAGScheduler: Broadcasting large task binary with size 1009.4 KiB\n",
      "25/12/12 14:59:51 WARN DAGScheduler: Broadcasting large task binary with size 1012.5 KiB\n",
      "25/12/12 14:59:51 WARN DAGScheduler: Broadcasting large task binary with size 1018.0 KiB\n",
      "25/12/12 14:59:51 WARN DAGScheduler: Broadcasting large task binary with size 1026.4 KiB\n",
      "25/12/12 14:59:51 WARN DAGScheduler: Broadcasting large task binary with size 1031.6 KiB\n",
      "25/12/12 14:59:51 WARN DAGScheduler: Broadcasting large task binary with size 1032.0 KiB\n",
      "25/12/12 14:59:52 WARN DAGScheduler: Broadcasting large task binary with size 1032.8 KiB\n",
      "25/12/12 14:59:52 WARN DAGScheduler: Broadcasting large task binary with size 1033.8 KiB\n",
      "25/12/12 14:59:52 WARN DAGScheduler: Broadcasting large task binary with size 1036.0 KiB\n",
      "25/12/12 14:59:52 WARN DAGScheduler: Broadcasting large task binary with size 1040.1 KiB\n",
      "25/12/12 14:59:52 WARN DAGScheduler: Broadcasting large task binary with size 1045.6 KiB\n",
      "25/12/12 14:59:52 WARN DAGScheduler: Broadcasting large task binary with size 1052.7 KiB\n",
      "25/12/12 14:59:52 WARN DAGScheduler: Broadcasting large task binary with size 1051.4 KiB\n",
      "25/12/12 14:59:52 WARN DAGScheduler: Broadcasting large task binary with size 1051.8 KiB\n",
      "25/12/12 14:59:52 WARN DAGScheduler: Broadcasting large task binary with size 1052.6 KiB\n",
      "25/12/12 14:59:53 WARN DAGScheduler: Broadcasting large task binary with size 1053.5 KiB\n",
      "25/12/12 14:59:53 WARN DAGScheduler: Broadcasting large task binary with size 1055.8 KiB\n",
      "25/12/12 14:59:53 WARN DAGScheduler: Broadcasting large task binary with size 1059.8 KiB\n",
      "25/12/12 14:59:53 WARN DAGScheduler: Broadcasting large task binary with size 1065.1 KiB\n",
      "25/12/12 14:59:53 WARN DAGScheduler: Broadcasting large task binary with size 1072.7 KiB\n",
      "25/12/12 14:59:53 WARN DAGScheduler: Broadcasting large task binary with size 1071.8 KiB\n",
      "25/12/12 14:59:53 WARN DAGScheduler: Broadcasting large task binary with size 1072.3 KiB\n",
      "25/12/12 14:59:53 WARN DAGScheduler: Broadcasting large task binary with size 1073.0 KiB\n",
      "25/12/12 14:59:53 WARN DAGScheduler: Broadcasting large task binary with size 1074.0 KiB\n",
      "25/12/12 14:59:53 WARN DAGScheduler: Broadcasting large task binary with size 1076.2 KiB\n",
      "25/12/12 14:59:53 WARN DAGScheduler: Broadcasting large task binary with size 1080.3 KiB\n",
      "25/12/12 14:59:54 WARN DAGScheduler: Broadcasting large task binary with size 1085.2 KiB\n",
      "25/12/12 14:59:54 WARN DAGScheduler: Broadcasting large task binary with size 1092.7 KiB\n",
      "25/12/12 14:59:54 WARN DAGScheduler: Broadcasting large task binary with size 1092.4 KiB\n",
      "25/12/12 14:59:54 WARN DAGScheduler: Broadcasting large task binary with size 1092.9 KiB\n",
      "25/12/12 14:59:54 WARN DAGScheduler: Broadcasting large task binary with size 1093.6 KiB\n",
      "25/12/12 14:59:54 WARN DAGScheduler: Broadcasting large task binary with size 1094.6 KiB\n",
      "25/12/12 14:59:54 WARN DAGScheduler: Broadcasting large task binary with size 1096.8 KiB\n",
      "25/12/12 14:59:54 WARN DAGScheduler: Broadcasting large task binary with size 1100.8 KiB\n",
      "25/12/12 14:59:54 WARN DAGScheduler: Broadcasting large task binary with size 1105.5 KiB\n",
      "25/12/12 14:59:54 WARN DAGScheduler: Broadcasting large task binary with size 1112.4 KiB\n",
      "25/12/12 14:59:54 WARN DAGScheduler: Broadcasting large task binary with size 1112.5 KiB\n",
      "25/12/12 14:59:55 WARN DAGScheduler: Broadcasting large task binary with size 1113.0 KiB\n",
      "25/12/12 14:59:55 WARN DAGScheduler: Broadcasting large task binary with size 1113.7 KiB\n",
      "25/12/12 14:59:55 WARN DAGScheduler: Broadcasting large task binary with size 1114.7 KiB\n",
      "25/12/12 14:59:55 WARN DAGScheduler: Broadcasting large task binary with size 1116.9 KiB\n",
      "25/12/12 14:59:55 WARN DAGScheduler: Broadcasting large task binary with size 1120.9 KiB\n",
      "25/12/12 14:59:55 WARN DAGScheduler: Broadcasting large task binary with size 1125.9 KiB\n",
      "25/12/12 14:59:55 WARN DAGScheduler: Broadcasting large task binary with size 1134.6 KiB\n",
      "25/12/12 14:59:55 WARN DAGScheduler: Broadcasting large task binary with size 1136.3 KiB\n",
      "25/12/12 14:59:55 WARN DAGScheduler: Broadcasting large task binary with size 1136.8 KiB\n",
      "25/12/12 14:59:55 WARN DAGScheduler: Broadcasting large task binary with size 1137.5 KiB\n",
      "25/12/12 14:59:55 WARN DAGScheduler: Broadcasting large task binary with size 1138.5 KiB\n",
      "25/12/12 14:59:56 WARN DAGScheduler: Broadcasting large task binary with size 1140.7 KiB\n",
      "25/12/12 14:59:56 WARN DAGScheduler: Broadcasting large task binary with size 1144.8 KiB\n",
      "25/12/12 14:59:56 WARN DAGScheduler: Broadcasting large task binary with size 1149.5 KiB\n",
      "25/12/12 14:59:56 WARN DAGScheduler: Broadcasting large task binary with size 1157.3 KiB\n",
      "25/12/12 14:59:56 WARN DAGScheduler: Broadcasting large task binary with size 1157.9 KiB\n",
      "25/12/12 14:59:56 WARN DAGScheduler: Broadcasting large task binary with size 1158.3 KiB\n",
      "25/12/12 14:59:56 WARN DAGScheduler: Broadcasting large task binary with size 1159.1 KiB\n",
      "25/12/12 14:59:56 WARN DAGScheduler: Broadcasting large task binary with size 1160.0 KiB\n",
      "25/12/12 14:59:56 WARN DAGScheduler: Broadcasting large task binary with size 1162.3 KiB\n",
      "25/12/12 14:59:56 WARN DAGScheduler: Broadcasting large task binary with size 1166.4 KiB\n",
      "25/12/12 14:59:56 WARN DAGScheduler: Broadcasting large task binary with size 1171.9 KiB\n",
      "25/12/12 14:59:57 WARN DAGScheduler: Broadcasting large task binary with size 1181.0 KiB\n",
      "25/12/12 14:59:57 WARN DAGScheduler: Broadcasting large task binary with size 1181.0 KiB\n",
      "25/12/12 14:59:57 WARN DAGScheduler: Broadcasting large task binary with size 1181.5 KiB\n",
      "25/12/12 14:59:57 WARN DAGScheduler: Broadcasting large task binary with size 1182.2 KiB\n",
      "25/12/12 14:59:57 WARN DAGScheduler: Broadcasting large task binary with size 1183.2 KiB\n",
      "25/12/12 14:59:57 WARN DAGScheduler: Broadcasting large task binary with size 1185.5 KiB\n",
      "25/12/12 14:59:57 WARN DAGScheduler: Broadcasting large task binary with size 1189.5 KiB\n",
      "25/12/12 14:59:57 WARN DAGScheduler: Broadcasting large task binary with size 1195.1 KiB\n",
      "25/12/12 14:59:57 WARN DAGScheduler: Broadcasting large task binary with size 1204.5 KiB\n",
      "25/12/12 14:59:57 WARN DAGScheduler: Broadcasting large task binary with size 1204.9 KiB\n",
      "25/12/12 14:59:58 WARN DAGScheduler: Broadcasting large task binary with size 1205.3 KiB\n",
      "25/12/12 14:59:58 WARN DAGScheduler: Broadcasting large task binary with size 1206.0 KiB\n",
      "25/12/12 14:59:58 WARN DAGScheduler: Broadcasting large task binary with size 1207.0 KiB\n",
      "25/12/12 14:59:58 WARN DAGScheduler: Broadcasting large task binary with size 1209.3 KiB\n",
      "25/12/12 14:59:58 WARN DAGScheduler: Broadcasting large task binary with size 1213.0 KiB\n",
      "25/12/12 14:59:58 WARN DAGScheduler: Broadcasting large task binary with size 1217.4 KiB\n",
      "25/12/12 14:59:58 WARN DAGScheduler: Broadcasting large task binary with size 1223.4 KiB\n",
      "25/12/12 14:59:58 WARN DAGScheduler: Broadcasting large task binary with size 1223.0 KiB\n",
      "25/12/12 14:59:58 WARN DAGScheduler: Broadcasting large task binary with size 1223.5 KiB\n",
      "25/12/12 14:59:58 WARN DAGScheduler: Broadcasting large task binary with size 1224.2 KiB\n",
      "25/12/12 14:59:58 WARN DAGScheduler: Broadcasting large task binary with size 1225.2 KiB\n",
      "25/12/12 14:59:58 WARN DAGScheduler: Broadcasting large task binary with size 1227.4 KiB\n",
      "25/12/12 14:59:59 WARN DAGScheduler: Broadcasting large task binary with size 1231.5 KiB\n",
      "25/12/12 14:59:59 WARN DAGScheduler: Broadcasting large task binary with size 1236.7 KiB\n",
      "25/12/12 14:59:59 WARN DAGScheduler: Broadcasting large task binary with size 1245.3 KiB\n",
      "25/12/12 14:59:59 WARN DAGScheduler: Broadcasting large task binary with size 1245.0 KiB\n",
      "25/12/12 14:59:59 WARN DAGScheduler: Broadcasting large task binary with size 1245.5 KiB\n",
      "25/12/12 14:59:59 WARN DAGScheduler: Broadcasting large task binary with size 1246.2 KiB\n",
      "25/12/12 14:59:59 WARN DAGScheduler: Broadcasting large task binary with size 1247.2 KiB\n",
      "25/12/12 14:59:59 WARN DAGScheduler: Broadcasting large task binary with size 1249.5 KiB\n",
      "25/12/12 14:59:59 WARN DAGScheduler: Broadcasting large task binary with size 1253.5 KiB\n",
      "25/12/12 14:59:59 WARN DAGScheduler: Broadcasting large task binary with size 1259.1 KiB\n",
      "25/12/12 15:00:00 WARN DAGScheduler: Broadcasting large task binary with size 1268.3 KiB\n",
      "25/12/12 15:00:00 WARN DAGScheduler: Broadcasting large task binary with size 1269.2 KiB\n",
      "25/12/12 15:00:00 WARN DAGScheduler: Broadcasting large task binary with size 1269.7 KiB\n",
      "25/12/12 15:00:00 WARN DAGScheduler: Broadcasting large task binary with size 1270.4 KiB\n",
      "25/12/12 15:00:00 WARN DAGScheduler: Broadcasting large task binary with size 1271.4 KiB\n",
      "25/12/12 15:00:00 WARN DAGScheduler: Broadcasting large task binary with size 1273.6 KiB\n",
      "25/12/12 15:00:00 WARN DAGScheduler: Broadcasting large task binary with size 1277.5 KiB\n",
      "25/12/12 15:00:01 WARN DAGScheduler: Broadcasting large task binary with size 1282.7 KiB\n",
      "25/12/12 15:00:01 WARN DAGScheduler: Broadcasting large task binary with size 1291.5 KiB\n",
      "25/12/12 15:00:01 WARN DAGScheduler: Broadcasting large task binary with size 1291.7 KiB\n",
      "25/12/12 15:00:02 WARN DAGScheduler: Broadcasting large task binary with size 1292.2 KiB\n",
      "25/12/12 15:00:02 WARN DAGScheduler: Broadcasting large task binary with size 1292.9 KiB\n",
      "25/12/12 15:00:02 WARN DAGScheduler: Broadcasting large task binary with size 1293.9 KiB\n",
      "25/12/12 15:00:02 WARN DAGScheduler: Broadcasting large task binary with size 1296.2 KiB\n",
      "25/12/12 15:00:02 WARN DAGScheduler: Broadcasting large task binary with size 1300.2 KiB\n",
      "25/12/12 15:00:02 WARN DAGScheduler: Broadcasting large task binary with size 1305.8 KiB\n",
      "25/12/12 15:00:02 WARN DAGScheduler: Broadcasting large task binary with size 1314.9 KiB\n",
      "25/12/12 15:00:02 WARN DAGScheduler: Broadcasting large task binary with size 1315.6 KiB\n",
      "25/12/12 15:00:02 WARN DAGScheduler: Broadcasting large task binary with size 1316.0 KiB\n",
      "25/12/12 15:00:02 WARN DAGScheduler: Broadcasting large task binary with size 1316.7 KiB\n",
      "25/12/12 15:00:03 WARN DAGScheduler: Broadcasting large task binary with size 1317.7 KiB\n",
      "25/12/12 15:00:03 WARN DAGScheduler: Broadcasting large task binary with size 1320.0 KiB\n",
      "25/12/12 15:00:03 WARN DAGScheduler: Broadcasting large task binary with size 1323.7 KiB\n",
      "25/12/12 15:00:03 WARN DAGScheduler: Broadcasting large task binary with size 1328.7 KiB\n",
      "25/12/12 15:00:03 WARN DAGScheduler: Broadcasting large task binary with size 1336.7 KiB\n",
      "25/12/12 15:00:03 WARN DAGScheduler: Broadcasting large task binary with size 1337.4 KiB\n",
      "25/12/12 15:00:03 WARN DAGScheduler: Broadcasting large task binary with size 1337.9 KiB\n",
      "25/12/12 15:00:03 WARN DAGScheduler: Broadcasting large task binary with size 1338.6 KiB\n",
      "25/12/12 15:00:03 WARN DAGScheduler: Broadcasting large task binary with size 1339.6 KiB\n",
      "25/12/12 15:00:03 WARN DAGScheduler: Broadcasting large task binary with size 1341.9 KiB\n",
      "25/12/12 15:00:03 WARN DAGScheduler: Broadcasting large task binary with size 1346.0 KiB\n",
      "25/12/12 15:00:03 WARN DAGScheduler: Broadcasting large task binary with size 1352.1 KiB\n",
      "25/12/12 15:00:04 WARN DAGScheduler: Broadcasting large task binary with size 1362.1 KiB\n",
      "25/12/12 15:00:04 WARN DAGScheduler: Broadcasting large task binary with size 1363.0 KiB\n",
      "25/12/12 15:00:04 WARN DAGScheduler: Broadcasting large task binary with size 1363.5 KiB\n",
      "25/12/12 15:00:04 WARN DAGScheduler: Broadcasting large task binary with size 1364.2 KiB\n",
      "25/12/12 15:00:04 WARN DAGScheduler: Broadcasting large task binary with size 1365.2 KiB\n",
      "25/12/12 15:00:04 WARN DAGScheduler: Broadcasting large task binary with size 1367.5 KiB\n",
      "25/12/12 15:00:04 WARN DAGScheduler: Broadcasting large task binary with size 1371.6 KiB\n",
      "25/12/12 15:00:04 WARN DAGScheduler: Broadcasting large task binary with size 1377.7 KiB\n",
      "25/12/12 15:00:04 WARN DAGScheduler: Broadcasting large task binary with size 1388.1 KiB\n",
      "25/12/12 15:00:04 WARN DAGScheduler: Broadcasting large task binary with size 1388.6 KiB\n",
      "25/12/12 15:00:04 WARN DAGScheduler: Broadcasting large task binary with size 1389.1 KiB\n",
      "25/12/12 15:00:04 WARN DAGScheduler: Broadcasting large task binary with size 1389.8 KiB\n",
      "25/12/12 15:00:05 WARN DAGScheduler: Broadcasting large task binary with size 1390.8 KiB\n",
      "25/12/12 15:00:05 WARN DAGScheduler: Broadcasting large task binary with size 1393.1 KiB\n",
      "25/12/12 15:00:05 WARN DAGScheduler: Broadcasting large task binary with size 1396.9 KiB\n",
      "25/12/12 15:00:05 WARN DAGScheduler: Broadcasting large task binary with size 1402.1 KiB\n",
      "25/12/12 15:00:05 WARN DAGScheduler: Broadcasting large task binary with size 1411.0 KiB\n",
      "25/12/12 15:00:05 WARN DAGScheduler: Broadcasting large task binary with size 1412.0 KiB\n",
      "25/12/12 15:00:05 WARN DAGScheduler: Broadcasting large task binary with size 1412.5 KiB\n",
      "25/12/12 15:00:05 WARN DAGScheduler: Broadcasting large task binary with size 1413.2 KiB\n",
      "25/12/12 15:00:05 WARN DAGScheduler: Broadcasting large task binary with size 1414.2 KiB\n",
      "25/12/12 15:00:05 WARN DAGScheduler: Broadcasting large task binary with size 1416.4 KiB\n",
      "25/12/12 15:00:05 WARN DAGScheduler: Broadcasting large task binary with size 1420.5 KiB\n",
      "25/12/12 15:00:06 WARN DAGScheduler: Broadcasting large task binary with size 1426.0 KiB\n",
      "25/12/12 15:00:06 WARN DAGScheduler: Broadcasting large task binary with size 1434.9 KiB\n",
      "25/12/12 15:00:06 WARN DAGScheduler: Broadcasting large task binary with size 1435.8 KiB\n",
      "25/12/12 15:00:06 WARN DAGScheduler: Broadcasting large task binary with size 1436.2 KiB\n",
      "25/12/12 15:00:06 WARN DAGScheduler: Broadcasting large task binary with size 1437.0 KiB\n",
      "25/12/12 15:00:06 WARN DAGScheduler: Broadcasting large task binary with size 1437.9 KiB\n",
      "25/12/12 15:00:06 WARN DAGScheduler: Broadcasting large task binary with size 1440.2 KiB\n",
      "25/12/12 15:00:06 WARN DAGScheduler: Broadcasting large task binary with size 1444.2 KiB\n",
      "25/12/12 15:00:06 WARN DAGScheduler: Broadcasting large task binary with size 1449.8 KiB\n",
      "25/12/12 15:00:06 WARN DAGScheduler: Broadcasting large task binary with size 1459.2 KiB\n",
      "25/12/12 15:00:07 WARN DAGScheduler: Broadcasting large task binary with size 1458.6 KiB\n",
      "25/12/12 15:00:07 WARN DAGScheduler: Broadcasting large task binary with size 1459.1 KiB\n",
      "25/12/12 15:00:07 WARN DAGScheduler: Broadcasting large task binary with size 1459.8 KiB\n",
      "25/12/12 15:00:07 WARN DAGScheduler: Broadcasting large task binary with size 1460.8 KiB\n",
      "25/12/12 15:00:07 WARN DAGScheduler: Broadcasting large task binary with size 1463.1 KiB\n",
      "25/12/12 15:00:07 WARN DAGScheduler: Broadcasting large task binary with size 1467.2 KiB\n",
      "25/12/12 15:00:07 WARN DAGScheduler: Broadcasting large task binary with size 1473.3 KiB\n",
      "25/12/12 15:00:07 WARN DAGScheduler: Broadcasting large task binary with size 1483.6 KiB\n",
      "25/12/12 15:00:07 WARN DAGScheduler: Broadcasting large task binary with size 1483.9 KiB\n",
      "25/12/12 15:00:07 WARN DAGScheduler: Broadcasting large task binary with size 1484.4 KiB\n",
      "25/12/12 15:00:07 WARN DAGScheduler: Broadcasting large task binary with size 1485.1 KiB\n",
      "25/12/12 15:00:07 WARN DAGScheduler: Broadcasting large task binary with size 1486.1 KiB\n",
      "25/12/12 15:00:08 WARN DAGScheduler: Broadcasting large task binary with size 1488.3 KiB\n",
      "25/12/12 15:00:08 WARN DAGScheduler: Broadcasting large task binary with size 1492.2 KiB\n",
      "25/12/12 15:00:08 WARN DAGScheduler: Broadcasting large task binary with size 1497.3 KiB\n",
      "25/12/12 15:00:08 WARN DAGScheduler: Broadcasting large task binary with size 1504.2 KiB\n",
      "25/12/12 15:00:08 WARN DAGScheduler: Broadcasting large task binary with size 1503.5 KiB\n",
      "25/12/12 15:00:08 WARN DAGScheduler: Broadcasting large task binary with size 1504.0 KiB\n",
      "25/12/12 15:00:08 WARN DAGScheduler: Broadcasting large task binary with size 1504.7 KiB\n",
      "25/12/12 15:00:08 WARN DAGScheduler: Broadcasting large task binary with size 1505.7 KiB\n",
      "25/12/12 15:00:08 WARN DAGScheduler: Broadcasting large task binary with size 1508.0 KiB\n",
      "25/12/12 15:00:08 WARN DAGScheduler: Broadcasting large task binary with size 1512.1 KiB\n",
      "25/12/12 15:00:08 WARN DAGScheduler: Broadcasting large task binary with size 1518.2 KiB\n",
      "25/12/12 15:00:09 WARN DAGScheduler: Broadcasting large task binary with size 1528.6 KiB\n",
      "25/12/12 15:00:09 WARN DAGScheduler: Broadcasting large task binary with size 1529.8 KiB\n",
      "25/12/12 15:00:09 WARN DAGScheduler: Broadcasting large task binary with size 1530.3 KiB\n",
      "25/12/12 15:00:09 WARN DAGScheduler: Broadcasting large task binary with size 1531.0 KiB\n",
      "25/12/12 15:00:09 WARN DAGScheduler: Broadcasting large task binary with size 1532.0 KiB\n",
      "25/12/12 15:00:09 WARN DAGScheduler: Broadcasting large task binary with size 1534.2 KiB\n",
      "25/12/12 15:00:09 WARN DAGScheduler: Broadcasting large task binary with size 1538.3 KiB\n",
      "25/12/12 15:00:09 WARN DAGScheduler: Broadcasting large task binary with size 1543.8 KiB\n",
      "25/12/12 15:00:09 WARN DAGScheduler: Broadcasting large task binary with size 1551.7 KiB\n",
      "25/12/12 15:00:09 WARN DAGScheduler: Broadcasting large task binary with size 1550.9 KiB\n",
      "25/12/12 15:00:09 WARN DAGScheduler: Broadcasting large task binary with size 1551.3 KiB\n",
      "25/12/12 15:00:10 WARN DAGScheduler: Broadcasting large task binary with size 1552.0 KiB\n",
      "25/12/12 15:00:10 WARN DAGScheduler: Broadcasting large task binary with size 1553.0 KiB\n",
      "25/12/12 15:00:10 WARN DAGScheduler: Broadcasting large task binary with size 1555.3 KiB\n",
      "25/12/12 15:00:10 WARN DAGScheduler: Broadcasting large task binary with size 1559.1 KiB\n",
      "25/12/12 15:00:10 WARN DAGScheduler: Broadcasting large task binary with size 1564.4 KiB\n",
      "25/12/12 15:00:10 WARN DAGScheduler: Broadcasting large task binary with size 1572.9 KiB\n",
      "25/12/12 15:00:10 WARN DAGScheduler: Broadcasting large task binary with size 1572.7 KiB\n",
      "25/12/12 15:00:10 WARN DAGScheduler: Broadcasting large task binary with size 1573.2 KiB\n",
      "25/12/12 15:00:10 WARN DAGScheduler: Broadcasting large task binary with size 1573.9 KiB\n",
      "25/12/12 15:00:10 WARN DAGScheduler: Broadcasting large task binary with size 1574.9 KiB\n",
      "25/12/12 15:00:11 WARN DAGScheduler: Broadcasting large task binary with size 1577.2 KiB\n",
      "25/12/12 15:00:11 WARN DAGScheduler: Broadcasting large task binary with size 1581.3 KiB\n",
      "25/12/12 15:00:11 WARN DAGScheduler: Broadcasting large task binary with size 1587.4 KiB\n",
      "25/12/12 15:00:11 WARN DAGScheduler: Broadcasting large task binary with size 1598.1 KiB\n",
      "25/12/12 15:00:11 WARN DAGScheduler: Broadcasting large task binary with size 1598.5 KiB\n",
      "25/12/12 15:00:11 WARN DAGScheduler: Broadcasting large task binary with size 1599.0 KiB\n",
      "25/12/12 15:00:11 WARN DAGScheduler: Broadcasting large task binary with size 1599.7 KiB\n",
      "25/12/12 15:00:12 WARN DAGScheduler: Broadcasting large task binary with size 1600.7 KiB\n",
      "25/12/12 15:00:12 WARN DAGScheduler: Broadcasting large task binary with size 1602.9 KiB\n",
      "25/12/12 15:00:12 WARN DAGScheduler: Broadcasting large task binary with size 1607.1 KiB\n",
      "25/12/12 15:00:12 WARN DAGScheduler: Broadcasting large task binary with size 1613.2 KiB\n",
      "25/12/12 15:00:12 WARN DAGScheduler: Broadcasting large task binary with size 1623.3 KiB\n",
      "25/12/12 15:00:12 WARN DAGScheduler: Broadcasting large task binary with size 1622.6 KiB\n",
      "25/12/12 15:00:12 WARN DAGScheduler: Broadcasting large task binary with size 1623.1 KiB\n",
      "25/12/12 15:00:12 WARN DAGScheduler: Broadcasting large task binary with size 1623.8 KiB\n",
      "25/12/12 15:00:12 WARN DAGScheduler: Broadcasting large task binary with size 1624.8 KiB\n",
      "25/12/12 15:00:12 WARN DAGScheduler: Broadcasting large task binary with size 1627.1 KiB\n",
      "25/12/12 15:00:12 WARN DAGScheduler: Broadcasting large task binary with size 1631.2 KiB\n",
      "25/12/12 15:00:13 WARN DAGScheduler: Broadcasting large task binary with size 1637.3 KiB\n",
      "25/12/12 15:00:13 WARN DAGScheduler: Broadcasting large task binary with size 1647.0 KiB\n",
      "25/12/12 15:00:13 WARN DAGScheduler: Broadcasting large task binary with size 1647.1 KiB\n",
      "25/12/12 15:00:13 WARN DAGScheduler: Broadcasting large task binary with size 1647.6 KiB\n",
      "25/12/12 15:00:13 WARN DAGScheduler: Broadcasting large task binary with size 1648.3 KiB\n",
      "25/12/12 15:00:13 WARN DAGScheduler: Broadcasting large task binary with size 1649.3 KiB\n",
      "25/12/12 15:00:13 WARN DAGScheduler: Broadcasting large task binary with size 1651.5 KiB\n",
      "25/12/12 15:00:13 WARN DAGScheduler: Broadcasting large task binary with size 1655.7 KiB\n",
      "25/12/12 15:00:13 WARN DAGScheduler: Broadcasting large task binary with size 1662.1 KiB\n",
      "25/12/12 15:00:13 WARN DAGScheduler: Broadcasting large task binary with size 1673.4 KiB\n",
      "25/12/12 15:00:13 WARN DAGScheduler: Broadcasting large task binary with size 1674.0 KiB\n",
      "25/12/12 15:00:14 WARN DAGScheduler: Broadcasting large task binary with size 1674.5 KiB\n",
      "25/12/12 15:00:14 WARN DAGScheduler: Broadcasting large task binary with size 1675.2 KiB\n",
      "25/12/12 15:00:14 WARN DAGScheduler: Broadcasting large task binary with size 1676.2 KiB\n",
      "25/12/12 15:00:14 WARN DAGScheduler: Broadcasting large task binary with size 1678.4 KiB\n",
      "25/12/12 15:00:14 WARN DAGScheduler: Broadcasting large task binary with size 1682.6 KiB\n",
      "25/12/12 15:00:14 WARN DAGScheduler: Broadcasting large task binary with size 1689.0 KiB\n",
      "25/12/12 15:00:14 WARN DAGScheduler: Broadcasting large task binary with size 1700.2 KiB\n",
      "25/12/12 15:00:14 WARN DAGScheduler: Broadcasting large task binary with size 1700.9 KiB\n",
      "25/12/12 15:00:14 WARN DAGScheduler: Broadcasting large task binary with size 1701.4 KiB\n",
      "25/12/12 15:00:14 WARN DAGScheduler: Broadcasting large task binary with size 1702.1 KiB\n",
      "25/12/12 15:00:14 WARN DAGScheduler: Broadcasting large task binary with size 1703.1 KiB\n",
      "25/12/12 15:00:14 WARN DAGScheduler: Broadcasting large task binary with size 1705.3 KiB\n",
      "25/12/12 15:00:15 WARN DAGScheduler: Broadcasting large task binary with size 1709.5 KiB\n",
      "25/12/12 15:00:15 WARN DAGScheduler: Broadcasting large task binary with size 1715.6 KiB\n",
      "25/12/12 15:00:15 WARN DAGScheduler: Broadcasting large task binary with size 1725.8 KiB\n",
      "25/12/12 15:00:15 WARN DAGScheduler: Broadcasting large task binary with size 1725.7 KiB\n",
      "25/12/12 15:00:15 WARN DAGScheduler: Broadcasting large task binary with size 1726.2 KiB\n",
      "25/12/12 15:00:15 WARN DAGScheduler: Broadcasting large task binary with size 1726.9 KiB\n",
      "25/12/12 15:00:15 WARN DAGScheduler: Broadcasting large task binary with size 1727.9 KiB\n",
      "25/12/12 15:00:15 WARN DAGScheduler: Broadcasting large task binary with size 1730.1 KiB\n",
      "25/12/12 15:00:15 WARN DAGScheduler: Broadcasting large task binary with size 1734.2 KiB\n",
      "25/12/12 15:00:16 WARN DAGScheduler: Broadcasting large task binary with size 1740.3 KiB\n",
      "25/12/12 15:00:16 WARN DAGScheduler: Broadcasting large task binary with size 1749.4 KiB\n",
      "25/12/12 15:00:18 WARN DAGScheduler: Broadcasting large task binary with size 1748.7 KiB\n",
      "25/12/12 15:00:20 WARN DAGScheduler: Broadcasting large task binary with size 1749.2 KiB\n",
      "25/12/12 15:00:27 WARN DAGScheduler: Broadcasting large task binary with size 1749.9 KiB\n",
      "25/12/12 15:00:27 WARN DAGScheduler: Broadcasting large task binary with size 1750.9 KiB\n",
      "25/12/12 15:00:27 WARN DAGScheduler: Broadcasting large task binary with size 1753.2 KiB\n",
      "25/12/12 15:00:27 WARN DAGScheduler: Broadcasting large task binary with size 1757.3 KiB\n",
      "25/12/12 15:00:27 WARN DAGScheduler: Broadcasting large task binary with size 1763.4 KiB\n",
      "25/12/12 15:00:28 WARN DAGScheduler: Broadcasting large task binary with size 1773.4 KiB\n",
      "25/12/12 15:00:29 WARN DAGScheduler: Broadcasting large task binary with size 1773.9 KiB\n",
      "25/12/12 15:00:29 WARN DAGScheduler: Broadcasting large task binary with size 1774.3 KiB\n",
      "25/12/12 15:00:30 WARN DAGScheduler: Broadcasting large task binary with size 1775.1 KiB\n",
      "25/12/12 15:00:30 WARN DAGScheduler: Broadcasting large task binary with size 1776.0 KiB\n",
      "25/12/12 15:00:30 WARN DAGScheduler: Broadcasting large task binary with size 1778.0 KiB\n",
      "25/12/12 15:00:30 WARN DAGScheduler: Broadcasting large task binary with size 1782.0 KiB\n",
      "25/12/12 15:00:30 WARN DAGScheduler: Broadcasting large task binary with size 1788.6 KiB\n",
      "25/12/12 15:00:30 WARN DAGScheduler: Broadcasting large task binary with size 1799.6 KiB\n",
      "25/12/12 15:00:30 WARN DAGScheduler: Broadcasting large task binary with size 1801.1 KiB\n",
      "25/12/12 15:00:30 WARN DAGScheduler: Broadcasting large task binary with size 1801.6 KiB\n",
      "25/12/12 15:00:31 WARN DAGScheduler: Broadcasting large task binary with size 1802.3 KiB\n",
      "25/12/12 15:00:31 WARN ProcessingTimeExecutor: Current batch is falling behind. The trigger interval is 10000 milliseconds, but spent 11499 milliseconds\n",
      "25/12/12 15:00:31 WARN DAGScheduler: Broadcasting large task binary with size 1803.3 KiB\n",
      "25/12/12 15:00:31 WARN DAGScheduler: Broadcasting large task binary with size 1805.3 KiB\n",
      "25/12/12 15:00:32 WARN DAGScheduler: Broadcasting large task binary with size 1809.2 KiB\n",
      "25/12/12 15:00:32 WARN DAGScheduler: Broadcasting large task binary with size 1815.8 KiB\n",
      "25/12/12 15:00:32 WARN DAGScheduler: Broadcasting large task binary with size 1826.9 KiB\n",
      "25/12/12 15:00:32 WARN DAGScheduler: Broadcasting large task binary with size 1828.6 KiB\n",
      "25/12/12 15:00:32 WARN DAGScheduler: Broadcasting large task binary with size 1829.1 KiB\n",
      "25/12/12 15:00:32 WARN DAGScheduler: Broadcasting large task binary with size 1829.8 KiB\n",
      "25/12/12 15:00:32 WARN DAGScheduler: Broadcasting large task binary with size 1830.8 KiB\n",
      "25/12/12 15:00:32 WARN DAGScheduler: Broadcasting large task binary with size 1832.8 KiB\n",
      "25/12/12 15:00:33 WARN DAGScheduler: Broadcasting large task binary with size 1836.7 KiB\n",
      "25/12/12 15:00:33 WARN DAGScheduler: Broadcasting large task binary with size 1843.6 KiB\n",
      "25/12/12 15:00:33 WARN DAGScheduler: Broadcasting large task binary with size 1853.8 KiB\n",
      "25/12/12 15:00:33 WARN DAGScheduler: Broadcasting large task binary with size 1854.3 KiB\n",
      "25/12/12 15:00:33 WARN DAGScheduler: Broadcasting large task binary with size 1854.7 KiB\n",
      "25/12/12 15:00:33 WARN DAGScheduler: Broadcasting large task binary with size 1855.5 KiB\n",
      "25/12/12 15:00:33 WARN DAGScheduler: Broadcasting large task binary with size 1856.4 KiB\n",
      "25/12/12 15:00:33 WARN DAGScheduler: Broadcasting large task binary with size 1858.4 KiB\n",
      "25/12/12 15:00:33 WARN DAGScheduler: Broadcasting large task binary with size 1861.8 KiB\n",
      "25/12/12 15:00:34 WARN DAGScheduler: Broadcasting large task binary with size 1867.6 KiB\n",
      "25/12/12 15:00:34 WARN DAGScheduler: Broadcasting large task binary with size 1877.4 KiB\n",
      "25/12/12 15:00:34 WARN DAGScheduler: Broadcasting large task binary with size 1878.3 KiB\n",
      "25/12/12 15:00:34 WARN DAGScheduler: Broadcasting large task binary with size 1878.7 KiB\n",
      "25/12/12 15:00:34 WARN DAGScheduler: Broadcasting large task binary with size 1879.4 KiB\n",
      "25/12/12 15:00:34 WARN DAGScheduler: Broadcasting large task binary with size 1880.4 KiB\n",
      "25/12/12 15:00:34 WARN DAGScheduler: Broadcasting large task binary with size 1882.4 KiB\n",
      "25/12/12 15:00:34 WARN DAGScheduler: Broadcasting large task binary with size 1886.3 KiB\n",
      "25/12/12 15:00:34 WARN DAGScheduler: Broadcasting large task binary with size 1892.5 KiB\n",
      "25/12/12 15:00:35 WARN DAGScheduler: Broadcasting large task binary with size 1902.8 KiB\n",
      "25/12/12 15:00:35 WARN DAGScheduler: Broadcasting large task binary with size 1904.0 KiB\n",
      "25/12/12 15:00:35 WARN DAGScheduler: Broadcasting large task binary with size 1904.5 KiB\n",
      "25/12/12 15:00:35 WARN DAGScheduler: Broadcasting large task binary with size 1905.2 KiB\n",
      "25/12/12 15:00:35 WARN DAGScheduler: Broadcasting large task binary with size 1906.2 KiB\n",
      "25/12/12 15:00:35 WARN DAGScheduler: Broadcasting large task binary with size 1908.5 KiB\n",
      "25/12/12 15:00:35 WARN DAGScheduler: Broadcasting large task binary with size 1913.0 KiB\n",
      "25/12/12 15:00:35 WARN DAGScheduler: Broadcasting large task binary with size 1921.6 KiB\n",
      "25/12/12 15:00:35 WARN DAGScheduler: Broadcasting large task binary with size 1936.4 KiB\n",
      "25/12/12 15:00:35 WARN DAGScheduler: Broadcasting large task binary with size 1937.7 KiB\n",
      "25/12/12 15:00:36 WARN DAGScheduler: Broadcasting large task binary with size 1938.2 KiB\n",
      "25/12/12 15:00:36 WARN DAGScheduler: Broadcasting large task binary with size 1938.9 KiB\n",
      "25/12/12 15:00:36 WARN DAGScheduler: Broadcasting large task binary with size 1939.9 KiB\n",
      "25/12/12 15:00:36 WARN DAGScheduler: Broadcasting large task binary with size 1942.2 KiB\n",
      "25/12/12 15:00:36 WARN DAGScheduler: Broadcasting large task binary with size 1946.7 KiB\n",
      "25/12/12 15:00:36 WARN DAGScheduler: Broadcasting large task binary with size 1955.6 KiB\n",
      "25/12/12 15:00:36 WARN DAGScheduler: Broadcasting large task binary with size 1971.0 KiB\n",
      "25/12/12 15:00:36 WARN DAGScheduler: Broadcasting large task binary with size 1972.1 KiB\n",
      "25/12/12 15:00:36 WARN DAGScheduler: Broadcasting large task binary with size 1972.6 KiB\n",
      "25/12/12 15:00:37 WARN DAGScheduler: Broadcasting large task binary with size 1973.3 KiB\n",
      "25/12/12 15:00:37 WARN DAGScheduler: Broadcasting large task binary with size 1974.3 KiB\n",
      "25/12/12 15:00:37 WARN DAGScheduler: Broadcasting large task binary with size 1976.5 KiB\n",
      "25/12/12 15:00:37 WARN DAGScheduler: Broadcasting large task binary with size 1980.4 KiB\n",
      "25/12/12 15:00:37 WARN DAGScheduler: Broadcasting large task binary with size 1987.6 KiB\n",
      "25/12/12 15:00:37 WARN DAGScheduler: Broadcasting large task binary with size 1998.9 KiB\n",
      "25/12/12 15:00:37 WARN DAGScheduler: Broadcasting large task binary with size 1999.5 KiB\n",
      "25/12/12 15:00:37 WARN DAGScheduler: Broadcasting large task binary with size 1999.9 KiB\n",
      "25/12/12 15:00:37 WARN DAGScheduler: Broadcasting large task binary with size 2000.7 KiB\n",
      "25/12/12 15:00:37 WARN DAGScheduler: Broadcasting large task binary with size 2001.4 KiB\n",
      "25/12/12 15:00:38 WARN DAGScheduler: Broadcasting large task binary with size 2003.1 KiB\n",
      "25/12/12 15:00:38 WARN DAGScheduler: Broadcasting large task binary with size 2006.5 KiB\n",
      "25/12/12 15:00:38 WARN DAGScheduler: Broadcasting large task binary with size 2012.4 KiB\n",
      "25/12/12 15:00:38 WARN DAGScheduler: Broadcasting large task binary with size 2023.8 KiB\n",
      "25/12/12 15:00:38 WARN DAGScheduler: Broadcasting large task binary with size 2024.7 KiB\n",
      "25/12/12 15:00:38 WARN DAGScheduler: Broadcasting large task binary with size 2025.2 KiB\n",
      "25/12/12 15:00:38 WARN DAGScheduler: Broadcasting large task binary with size 2025.9 KiB\n",
      "25/12/12 15:00:38 WARN DAGScheduler: Broadcasting large task binary with size 2026.9 KiB\n",
      "25/12/12 15:00:38 WARN DAGScheduler: Broadcasting large task binary with size 2029.2 KiB\n",
      "25/12/12 15:00:39 WARN DAGScheduler: Broadcasting large task binary with size 2033.7 KiB\n",
      "25/12/12 15:00:39 WARN DAGScheduler: Broadcasting large task binary with size 2041.8 KiB\n",
      "25/12/12 15:00:39 WARN DAGScheduler: Broadcasting large task binary with size 2.0 MiB\n",
      "25/12/12 15:00:39 WARN DAGScheduler: Broadcasting large task binary with size 2.0 MiB\n",
      "25/12/12 15:00:39 WARN DAGScheduler: Broadcasting large task binary with size 2.0 MiB\n",
      "25/12/12 15:00:39 WARN DAGScheduler: Broadcasting large task binary with size 2.0 MiB\n",
      "25/12/12 15:00:39 WARN DAGScheduler: Broadcasting large task binary with size 2.0 MiB\n",
      "25/12/12 15:00:39 WARN DAGScheduler: Broadcasting large task binary with size 2.0 MiB\n",
      "25/12/12 15:00:40 WARN DAGScheduler: Broadcasting large task binary with size 2.0 MiB\n",
      "25/12/12 15:00:40 WARN DAGScheduler: Broadcasting large task binary with size 2.0 MiB\n",
      "25/12/12 15:00:40 WARN DAGScheduler: Broadcasting large task binary with size 2.0 MiB\n",
      "25/12/12 15:00:40 WARN DAGScheduler: Broadcasting large task binary with size 2.0 MiB\n",
      "25/12/12 15:00:40 WARN DAGScheduler: Broadcasting large task binary with size 2.0 MiB\n",
      "25/12/12 15:00:40 WARN DAGScheduler: Broadcasting large task binary with size 2.0 MiB\n",
      "25/12/12 15:00:41 WARN DAGScheduler: Broadcasting large task binary with size 2.0 MiB\n",
      "25/12/12 15:00:41 WARN DAGScheduler: Broadcasting large task binary with size 2.0 MiB\n",
      "25/12/12 15:00:41 WARN DAGScheduler: Broadcasting large task binary with size 2.0 MiB\n",
      "25/12/12 15:00:41 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:41 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:41 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:42 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:42 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:42 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:42 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:42 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:42 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:42 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:42 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:42 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:42 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:43 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:43 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:43 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:43 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:43 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:43 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:43 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:43 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:43 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:44 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:44 WARN DAGScheduler: Broadcasting large task binary with size 2.1 MiB\n",
      "25/12/12 15:00:44 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:44 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:44 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:44 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:44 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:44 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:44 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:44 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:45 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:45 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:45 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:45 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:45 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:45 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:45 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:45 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:46 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:46 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:46 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:46 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:46 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:46 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:46 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:46 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB\n",
      "25/12/12 15:00:46 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:47 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:47 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:47 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:47 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:47 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:47 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:47 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:47 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:47 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:48 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:48 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:48 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:48 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:48 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:48 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:48 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:48 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:49 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:49 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:49 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:49 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:49 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:49 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:49 WARN DAGScheduler: Broadcasting large task binary with size 2.3 MiB\n",
      "25/12/12 15:00:49 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:49 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:49 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:50 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:50 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:50 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:50 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:50 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:50 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:51 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:51 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:51 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:51 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:51 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:52 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:52 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:52 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:52 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:52 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:52 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:52 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:52 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:53 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:53 WARN DAGScheduler: Broadcasting large task binary with size 2.4 MiB\n",
      "25/12/12 15:00:53 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:53 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:53 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:53 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:53 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:53 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:53 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:54 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:54 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:55 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:57 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:57 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:57 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:58 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:58 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:58 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:58 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:58 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:58 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:58 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:59 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:59 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:59 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:59 WARN DAGScheduler: Broadcasting large task binary with size 2.5 MiB\n",
      "25/12/12 15:00:59 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:00:59 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:00:59 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:00:59 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:00 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:00 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:00 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:00 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:00 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:01 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:01 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:01 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:02 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:02 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:02 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:02 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:02 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:03 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:03 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:03 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:03 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:03 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:03 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:03 WARN DAGScheduler: Broadcasting large task binary with size 2.6 MiB\n",
      "25/12/12 15:01:03 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:04 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:04 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:04 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:04 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:04 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:04 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:04 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:04 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:05 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:05 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:05 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:05 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:05 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:05 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:05 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:06 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:06 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:06 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:06 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:06 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:06 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:06 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:07 WARN DAGScheduler: Broadcasting large task binary with size 2.7 MiB\n",
      "25/12/12 15:01:07 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:07 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:07 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:07 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:07 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:07 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:08 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:08 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:08 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:08 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:08 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:08 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:08 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:09 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:09 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:09 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:09 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:09 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:09 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:09 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:10 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:10 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:10 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:10 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:10 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:11 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:11 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:11 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:11 WARN DAGScheduler: Broadcasting large task binary with size 2.8 MiB\n",
      "25/12/12 15:01:12 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:12 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:12 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:12 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:12 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:13 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:13 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:13 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:13 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:14 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:14 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:14 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:14 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:14 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:14 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:15 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:15 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:15 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:15 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:15 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:15 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:16 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:16 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:16 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:16 WARN DAGScheduler: Broadcasting large task binary with size 2.9 MiB\n",
      "25/12/12 15:01:16 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:16 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:16 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:17 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:17 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:17 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:17 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:17 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:17 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:18 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:18 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:18 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:18 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:18 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:18 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:18 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:18 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:19 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:19 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:19 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:19 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:19 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:19 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:19 WARN DAGScheduler: Broadcasting large task binary with size 3.0 MiB\n",
      "25/12/12 15:01:20 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:20 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:20 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:20 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:20 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:21 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:21 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:21 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:21 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:21 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:22 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:22 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:22 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:22 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:22 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:22 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:23 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:23 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:23 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:23 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:23 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:23 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:24 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:24 WARN DAGScheduler: Broadcasting large task binary with size 3.1 MiB\n",
      "25/12/12 15:01:24 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:24 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:24 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:24 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:24 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:24 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:25 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:25 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:25 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:25 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:25 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:26 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:26 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:26 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:27 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:27 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:27 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:28 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:30 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:31 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:31 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:31 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:31 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:31 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:31 WARN DAGScheduler: Broadcasting large task binary with size 3.2 MiB\n",
      "25/12/12 15:01:32 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:32 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:32 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:32 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:33 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:33 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:33 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:33 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:33 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:33 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:34 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:34 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:34 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:34 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:35 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:35 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:35 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:35 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:35 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:35 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:35 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:36 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:36 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:36 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:36 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB\n",
      "25/12/12 15:01:36 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:37 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:37 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:37 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:37 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:37 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:37 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:38 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:38 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:38 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:38 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:38 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:38 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:38 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:39 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:39 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:39 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:39 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:39 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:39 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:40 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:40 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:40 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:40 WARN DAGScheduler: Broadcasting large task binary with size 3.4 MiB\n",
      "25/12/12 15:01:40 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:41 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:41 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:41 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:41 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:42 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:42 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:42 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:42 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:42 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:43 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:43 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:43 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:43 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:43 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:43 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:44 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:44 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:44 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:44 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:44 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:44 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:45 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:45 WARN DAGScheduler: Broadcasting large task binary with size 3.5 MiB\n",
      "25/12/12 15:01:45 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:45 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:45 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:46 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:46 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:46 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:46 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:46 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:47 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:47 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:47 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:47 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:47 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:47 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:48 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:48 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:48 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:48 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:48 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:48 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:49 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:49 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:49 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:49 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB\n",
      "25/12/12 15:01:49 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:49 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:50 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:50 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:50 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:50 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:50 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:51 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:51 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:51 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:51 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:52 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:52 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:52 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:52 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:52 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:52 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:53 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:53 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:53 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:53 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:53 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:53 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:53 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:54 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:54 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:54 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:54 WARN DAGScheduler: Broadcasting large task binary with size 3.7 MiB\n",
      "25/12/12 15:01:54 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:54 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:54 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:54 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:55 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:55 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:55 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:55 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:55 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:56 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:56 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:56 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:56 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:56 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:56 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:56 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:57 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:57 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:57 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:57 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n",
      "25/12/12 15:01:57 WARN DAGScheduler: Broadcasting large task binary with size 3.8 MiB\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ” Modelo GBT entrenado correctamente\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                "
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "===== RESULTADOS =====\n",
      "RMSE: 3182667775.305606\n",
      "R2  : 0.13965466949711824\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                "
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ” Modelo guardado en: /opt/spark/models/contratos_gbt_pca\n"
     ]
    }
   ],
   "source": [
    "from pyspark.ml.regression import GBTRegressor\n",
    "from pyspark.ml.evaluation import RegressionEvaluator\n",
    "from pyspark.ml import Pipeline\n",
    "from pyspark.sql.functions import col\n",
    "\n",
    "# ============================================================\n",
    "# 1. SPLIT Train/Test\n",
    "# ============================================================\n",
    "\n",
    "train_df, test_df = df_final.randomSplit([0.8, 0.2], seed=42)\n",
    "\n",
    "print(\"âœ” Split realizado:\")\n",
    "print(f\"Train: {train_df.count()} filas\")\n",
    "print(f\"Test:  {test_df.count()} filas\")\n",
    "\n",
    "\n",
    "# ============================================================\n",
    "# 2. MODELO â€” GBTRegressor\n",
    "# ============================================================\n",
    "\n",
    "gbt = GBTRegressor(\n",
    "    featuresCol=\"pca_features\",\n",
    "    labelCol=\"valor_contrato\",\n",
    "    maxDepth=8,\n",
    "    maxIter=100,\n",
    "    stepSize=0.1\n",
    ")\n",
    "\n",
    "pipeline = Pipeline(stages=[gbt])\n",
    "\n",
    "# Entrenar\n",
    "model = pipeline.fit(train_df)\n",
    "\n",
    "print(\"âœ” Modelo GBT entrenado correctamente\")\n",
    "\n",
    "\n",
    "# ============================================================\n",
    "# 3. EVALUACIÃ“N\n",
    "# ============================================================\n",
    "\n",
    "predictions = model.transform(test_df)\n",
    "\n",
    "# Evaluadores\n",
    "evaluator_rmse = RegressionEvaluator(\n",
    "    labelCol=\"valor_contrato\",\n",
    "    predictionCol=\"prediction\",\n",
    "    metricName=\"rmse\"\n",
    ")\n",
    "\n",
    "evaluator_r2 = RegressionEvaluator(\n",
    "    labelCol=\"valor_contrato\",\n",
    "    predictionCol=\"prediction\",\n",
    "    metricName=\"r2\"\n",
    ")\n",
    "\n",
    "rmse = evaluator_rmse.evaluate(predictions)\n",
    "r2   = evaluator_r2.evaluate(predictions)\n",
    "\n",
    "print(\"\\n===== RESULTADOS =====\")\n",
    "print(f\"RMSE: {rmse}\")\n",
    "print(f\"R2  : {r2}\")\n",
    "\n",
    "\n",
    "# ============================================================\n",
    "# 4. GUARDAR MODELO (persistencia)\n",
    "# ============================================================\n",
    "\n",
    "MODEL_PATH = \"/opt/spark/models/contratos_gbt_pca\"\n",
    "\n",
    "model.write().overwrite().save(MODEL_PATH)\n",
    "\n",
    "print(f\"âœ” Modelo guardado en: {MODEL_PATH}\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "id": "00f7b1f2-9284-4b76-8f3d-e0b2630020fc",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "[Stage 2073:====================================>                  (8 + 4) / 12]"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "===== MÃ‰TRICAS DE REGRESIÃ“N =====\n",
      "RMSE : 37538846280.08359\n",
      "MAE  : 1823362335.9936445\n",
      "R2   : 0.9808515738734394\n",
      "MAPE : 2.470132240666463\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                "
     ]
    }
   ],
   "source": [
    "from pyspark.ml.evaluation import RegressionEvaluator\n",
    "from pyspark.sql.functions import col, abs\n",
    "\n",
    "# =====================================================\n",
    "# EvaluaciÃ³n\n",
    "# =====================================================\n",
    "preds = model.transform(test_df)\n",
    "\n",
    "# RMSE\n",
    "rmse = RegressionEvaluator(\n",
    "    labelCol=\"valor_contrato\",\n",
    "    predictionCol=\"prediction\",\n",
    "    metricName=\"rmse\"\n",
    ").evaluate(preds)\n",
    "\n",
    "# MAE\n",
    "mae = RegressionEvaluator(\n",
    "    labelCol=\"valor_contrato\",\n",
    "    predictionCol=\"prediction\",\n",
    "    metricName=\"mae\"\n",
    ").evaluate(preds)\n",
    "\n",
    "# R2\n",
    "r2 = RegressionEvaluator(\n",
    "    labelCol=\"valor_contrato\",\n",
    "    predictionCol=\"prediction\",\n",
    "    metricName=\"r2\"\n",
    ").evaluate(preds)\n",
    "\n",
    "# MAPE (no existe en Spark â†’ lo calculamos manual)\n",
    "preds_mape = preds.withColumn(\n",
    "    \"ape\",\n",
    "    abs((col(\"valor_contrato\") - col(\"prediction\")) / col(\"valor_contrato\"))\n",
    ")\n",
    "\n",
    "mape = preds_mape.selectExpr(\"avg(ape)\").first()[0]\n",
    "\n",
    "print(\"\\n===== MÃ‰TRICAS DE REGRESIÃ“N =====\")\n",
    "print(f\"RMSE : {rmse}\")\n",
    "print(f\"MAE  : {mae}\")\n",
    "print(f\"R2   : {r2}\")\n",
    "print(f\"MAPE : {mape}\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 26,
   "id": "85f0ae5e-59f6-4a3d-8d4f-340c0d35d3a9",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      " Predicciones en TRAIN calculadas\n",
      "Residuos calculados\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "[Stage 2510:=================================================>    (10 + 1) / 11]"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "===== ESTADÃSTICAS DE RESIDUOS =====\n",
      "Media de residuos    : -24329407.4310\n",
      "Desv. EstÃ¡ndar (Ïƒ)   : 769245226.0516\n",
      "Min residual         : -38878205591.4500\n",
      "Max residual         : 7224043891.9065\n",
      "\n",
      "Ïƒ = 769245226.0516\n",
      "Umbral = 2.8xÏƒ = 2153886632.9445\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                "
     ]
    }
   ],
   "source": [
    "from pyspark.sql.functions import col\n",
    "from pyspark.ml.evaluation import RegressionEvaluator\n",
    "\n",
    "# =====================================================\n",
    "# 1. CALCULAR PREDICCIONES EN TRAIN (para residuos)\n",
    "# =====================================================\n",
    "\n",
    "train_predictions = model.transform(train_df)\n",
    "print(\" Predicciones en TRAIN calculadas\")\n",
    "\n",
    "# =====================================================\n",
    "# 2. CALCULAR RESIDUOS (Errores)\n",
    "# =====================================================\n",
    "\n",
    "train_with_residuals = train_predictions.withColumn(\n",
    "    \"residual\",\n",
    "    col(\"valor_contrato\") - col(\"prediction\")\n",
    ")\n",
    "print(\"Residuos calculados\")\n",
    "\n",
    "# =====================================================\n",
    "# 3. CALCULAR DESVIACIÃ“N ESTÃNDAR DE RESIDUOS\n",
    "# =====================================================\n",
    "\n",
    "residual_stats = train_with_residuals.select(\"residual\").describe().collect()\n",
    "\n",
    "stddev_residual = float(residual_stats[2][1])  # stddev\n",
    "\n",
    "print(\"\\n===== ESTADÃSTICAS DE RESIDUOS =====\")\n",
    "print(f\"Media de residuos    : {float(residual_stats[1][1]):.4f}\")\n",
    "print(f\"Desv. EstÃ¡ndar (Ïƒ)   : {stddev_residual:.4f}\")\n",
    "print(f\"Min residual         : {float(residual_stats[3][1]):.4f}\")\n",
    "print(f\"Max residual         : {float(residual_stats[4][1]):.4f}\")\n",
    "\n",
    "SIGMA = stddev_residual\n",
    "THRESHOLD_MULTIPLIER = 2.8\n",
    "\n",
    "print(f\"\\nÏƒ = {SIGMA:.4f}\")\n",
    "print(f\"Umbral = 2.8xÏƒ = {THRESHOLD_MULTIPLIER * SIGMA:.4f}\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "id": "d8fa60c6-0d25-4fa1-8ef5-42036bbc199b",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Regla de detecciÃ³n aplicada al TEST set\n",
      "\n",
      "===== MUESTRA DE DETECCIONES =====\n",
      "+------------------+--------------+--------------------+-------------------+--------------------+----------+\n",
      "|id_contrato       |valor_contrato|prediction          |desviacion         |umbral_superior     |es_atipico|\n",
      "+------------------+--------------+--------------------+-------------------+--------------------+----------+\n",
      "|CO1.PCCNTR.1010730|6.0E8         |5.999333916975954E8 |66608.3024046421   |2.753820024642128E9 |LIBRE     |\n",
      "|CO1.PCCNTR.1038807|5.434145E7    |5.4181699626330994E7|159750.37366900593 |2.2080683325708632E9|LIBRE     |\n",
      "|CO1.PCCNTR.1052314|1874570.0     |1880494.5313510844  |-5924.531351084355 |2.1557671274758835E9|LIBRE     |\n",
      "|CO1.PCCNTR.1056933|1.68659978E8  |1.6857956723892766E8|80410.76107233763  |2.32246620018346E9  |LIBRE     |\n",
      "|CO1.PCCNTR.109538 |6.95339E7     |6.963915589977083E7 |-105255.8997708261 |2.223525788844303E9 |LIBRE     |\n",
      "|CO1.PCCNTR.1146226|3.42E7        |3.463207860796562E7 |-432078.6079656184 |2.188518711552498E9 |LIBRE     |\n",
      "|CO1.PCCNTR.1190322|1.7120002E7   |1.7126861944053818E7|-6859.94405381754  |2.171013494888586E9 |LIBRE     |\n",
      "|CO1.PCCNTR.125503 |2.005E7       |2.006424953250137E7 |-14249.532501369715|2.1739508824770336E9|LIBRE     |\n",
      "|CO1.PCCNTR.1324336|3.46113409E8  |3.4649114902205265E8|-377740.0220526457 |2.500377781966585E9 |LIBRE     |\n",
      "|CO1.PCCNTR.1325122|0.0           |-5477.911274981341  |5477.911274981341  |2.1538811550332575E9|LIBRE     |\n",
      "+------------------+--------------+--------------------+-------------------+--------------------+----------+\n",
      "only showing top 10 rows\n",
      "\n",
      "\n",
      "===== ESTADÃSTICAS DE DETECCIÃ“N =====\n",
      "Total de registros: 1209\n",
      "AtÃ­picos detectados: 2\n",
      "Porcentaje atÃ­picos: 0.17%\n"
     ]
    }
   ],
   "source": [
    "from pyspark.sql.functions import col, when, lit, current_timestamp\n",
    "\n",
    "# =====================================================\n",
    "# 4. APLICAR REGLA DE DETECCIÃ“N EN TEST\n",
    "# =====================================================\n",
    "\n",
    "test_predictions = model.transform(test_df)\n",
    "\n",
    "# Calcular desviaciÃ³n y aplicar regla\n",
    "# Regla: Si ValorReal > (ValorPredicho + 2.8 * Ïƒ) â†’ ATÃPICO\n",
    "\n",
    "threshold_value = THRESHOLD_MULTIPLIER * SIGMA\n",
    "\n",
    "test_with_anomalies = test_predictions.withColumn(\n",
    "    \"desviacion\",\n",
    "    col(\"valor_contrato\") - col(\"prediction\")\n",
    ").withColumn(\n",
    "    \"umbral_superior\",\n",
    "    col(\"prediction\") + lit(threshold_value)\n",
    ").withColumn(\n",
    "    \"es_atipico\",\n",
    "    when(\n",
    "        col(\"valor_contrato\") > col(\"umbral_superior\"),\n",
    "        lit(\"ATÃPICO\")\n",
    "    ).otherwise(lit(\"LIBRE\"))\n",
    ").withColumn(\n",
    "    \"timestamp_deteccion\",\n",
    "    current_timestamp()\n",
    ")\n",
    "\n",
    "print(\"Regla de detecciÃ³n aplicada al TEST set\")\n",
    "\n",
    "# =====================================================\n",
    "# 5. INSPECCIONAR RESULTADOS\n",
    "# =====================================================\n",
    "\n",
    "print(\"\\n===== MUESTRA DE DETECCIONES =====\")\n",
    "test_with_anomalies.select(\n",
    "    \"id_contrato\",\n",
    "    \"valor_contrato\",\n",
    "    \"prediction\",\n",
    "    \"desviacion\",\n",
    "    \"umbral_superior\",\n",
    "    \"es_atipico\"\n",
    ").show(10, truncate=False)\n",
    "\n",
    "# EstadÃ­sticas\n",
    "atipicos_count = test_with_anomalies.filter(col(\"es_atipico\") == \"ATÃPICO\").count()\n",
    "total_count = test_with_anomalies.count()\n",
    "porcentaje = (atipicos_count / total_count * 100) if total_count > 0 else 0\n",
    "\n",
    "print(f\"\\n===== ESTADÃSTICAS DE DETECCIÃ“N =====\")\n",
    "print(f\"Total de registros: {total_count}\")\n",
    "print(f\"AtÃ­picos detectados: {atipicos_count}\")\n",
    "print(f\"Porcentaje atÃ­picos: {porcentaje:.2f}%\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 28,
   "id": "632b2a22-34f1-4b02-b00e-857b1920cbc2",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "25/12/12 15:04:18 WARN DAGScheduler: Broadcasting large task binary with size 1356.8 KiB\n",
      "                                                                                "
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "Tabla 'gold_anomalies' guardada en: /opt/spark/data/delta/gold_anomalies\n",
      "\n",
      "===== SCHEMA gold_anomalies =====\n",
      "root\n",
      " |-- id_contrato: string (nullable = true)\n",
      " |-- valor_contrato: double (nullable = true)\n",
      " |-- prediction: double (nullable = true)\n",
      " |-- desviacion: double (nullable = true)\n",
      " |-- umbral_superior: double (nullable = true)\n",
      " |-- es_atipico: string (nullable = true)\n",
      " |-- timestamp_deteccion: timestamp (nullable = true)\n",
      "\n",
      "\n",
      "===== MUESTRA DE ANOMALÃAS DETECTADAS =====\n",
      "+------------------+--------------+---------------------+---------------------+---------------------+----------+--------------------------+\n",
      "|id_contrato       |valor_contrato|prediction           |desviacion           |umbral_superior      |es_atipico|timestamp_deteccion       |\n",
      "+------------------+--------------+---------------------+---------------------+---------------------+----------+--------------------------+\n",
      "|CO1.PCCNTR.8635099|8.910711903E9 |-2.3809270546326885E9|1.1291638957632689E10|-2.2704042168815613E8|ATÃPICO   |2025-12-12 15:04:18.511474|\n",
      "|CO1.PCCNTR.2452887|5.529337172E9 |2.1225354104171696E9 |3.4068017615828304E9 |4.276422043361702E9  |ATÃPICO   |2025-12-12 15:04:18.511474|\n",
      "+------------------+--------------+---------------------+---------------------+---------------------+----------+--------------------------+\n",
      "\n",
      "\n",
      "===== RESUMEN FINAL FASE 5 =====\n",
      "DesviaciÃ³n estÃ¡ndar (Ïƒ) de residuos: 769245226.0516\n",
      "Umbral de detecciÃ³n (2.8 Ã— Ïƒ): 2153886632.9445\n",
      "Total de registros analizados: 1209\n",
      "AtÃ­picos detectados: 2\n",
      "Tabla guardada en Delta Lake: /opt/spark/data/delta/gold_anomalies\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                "
     ]
    }
   ],
   "source": [
    "import shutil\n",
    "import os\n",
    "\n",
    "# =====================================================\n",
    "# 6. GUARDAR EN DELTA LAKE (gold_anomalies)\n",
    "# =====================================================\n",
    "\n",
    "GOLD_ANOMALIES_PATH = \"/opt/spark/data/delta/gold_anomalies\"\n",
    "\n",
    "# Limpiar si existe (opcional: cambiar a append si quieres histÃ³rico)\n",
    "if os.path.exists(GOLD_ANOMALIES_PATH):\n",
    "    shutil.rmtree(GOLD_ANOMALIES_PATH)\n",
    "    print(f\" Eliminado directorio anterior: {GOLD_ANOMALIES_PATH}\")\n",
    "\n",
    "# Seleccionar columnas relevantes para la tabla de anomalÃ­as\n",
    "anomalies_final = test_with_anomalies.select(\n",
    "    \"id_contrato\",\n",
    "    \"valor_contrato\",\n",
    "    \"prediction\",\n",
    "    \"desviacion\",\n",
    "    \"umbral_superior\",\n",
    "    \"es_atipico\",\n",
    "    \"timestamp_deteccion\"\n",
    ")\n",
    "\n",
    "# Guardar en Delta Lake\n",
    "anomalies_final.write \\\n",
    "    .format(\"delta\") \\\n",
    "    .mode(\"overwrite\") \\\n",
    "    .save(GOLD_ANOMALIES_PATH)\n",
    "\n",
    "print(f\"\\nTabla 'gold_anomalies' guardada en: {GOLD_ANOMALIES_PATH}\")\n",
    "\n",
    "# =====================================================\n",
    "# 7. VERIFICACIÃ“N FINAL\n",
    "# =====================================================\n",
    "\n",
    "# Cargar y mostrar la tabla guardada\n",
    "df_anomalies_check = spark.read.format(\"delta\").load(GOLD_ANOMALIES_PATH)\n",
    "\n",
    "print(\"\\n===== SCHEMA gold_anomalies =====\")\n",
    "df_anomalies_check.printSchema()\n",
    "\n",
    "print(\"\\n===== MUESTRA DE ANOMALÃAS DETECTADAS =====\")\n",
    "df_anomalies_check.filter(col(\"es_atipico\") == \"ATÃPICO\").show(10, truncate=False)\n",
    "\n",
    "# Resumen final\n",
    "print(\"\\n===== RESUMEN FINAL FASE 5 =====\")\n",
    "print(f\"DesviaciÃ³n estÃ¡ndar (Ïƒ) de residuos: {SIGMA:.4f}\")\n",
    "print(f\"Umbral de detecciÃ³n (2.8 Ã— Ïƒ): {threshold_value:.4f}\")\n",
    "print(f\"Total de registros analizados: {df_anomalies_check.count()}\")\n",
    "print(f\"AtÃ­picos detectados: {df_anomalies_check.filter(col('es_atipico') == 'ATÃPICO').count()}\")\n",
    "print(f\"Tabla guardada en Delta Lake: {GOLD_ANOMALIES_PATH}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "2790680d-204d-417e-a45d-4d029917d723",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.14"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
